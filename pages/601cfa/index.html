<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Security 请求全过程解析 | lql-notes</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="https://cdn.staticaly.com/gh/eryajf/tu/main/img/image_20220720_132133.ico">
    <script language="javascript" type="text/javascript" src="/lql-notes/js/pgmanor-self.js"></script>
    <meta name="description" content="vdoing博客主题模板">
    <meta name="keywords" content="故梦,golang,vue,go-web,go-admin,go-ldap-admin">
    <meta name="theme-color" content="#11a8cd">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <link rel="preload" href="/lql-notes/assets/css/0.styles.ea6535aa.css" as="style"><link rel="preload" href="/lql-notes/assets/js/app.9e66de21.js" as="script"><link rel="preload" href="/lql-notes/assets/js/4.cd41d527.js" as="script"><link rel="preload" href="/lql-notes/assets/js/18.0abab180.js" as="script"><link rel="prefetch" href="/lql-notes/assets/js/10.677df2c0.js"><link rel="prefetch" href="/lql-notes/assets/js/11.a399f09d.js"><link rel="prefetch" href="/lql-notes/assets/js/12.ac7ace7a.js"><link rel="prefetch" href="/lql-notes/assets/js/13.63ad14e1.js"><link rel="prefetch" href="/lql-notes/assets/js/14.63e9fec3.js"><link rel="prefetch" href="/lql-notes/assets/js/15.b37eb70f.js"><link rel="prefetch" href="/lql-notes/assets/js/16.e00678de.js"><link rel="prefetch" href="/lql-notes/assets/js/17.31393fde.js"><link rel="prefetch" href="/lql-notes/assets/js/19.d89cc771.js"><link rel="prefetch" href="/lql-notes/assets/js/20.3977931a.js"><link rel="prefetch" href="/lql-notes/assets/js/21.ec1083fc.js"><link rel="prefetch" href="/lql-notes/assets/js/22.1aa7293f.js"><link rel="prefetch" href="/lql-notes/assets/js/23.5790c202.js"><link rel="prefetch" href="/lql-notes/assets/js/24.43db876e.js"><link rel="prefetch" href="/lql-notes/assets/js/25.ba4f66a4.js"><link rel="prefetch" href="/lql-notes/assets/js/26.f84be612.js"><link rel="prefetch" href="/lql-notes/assets/js/27.9656c52e.js"><link rel="prefetch" href="/lql-notes/assets/js/28.af7e61e4.js"><link rel="prefetch" href="/lql-notes/assets/js/5.040616a7.js"><link rel="prefetch" href="/lql-notes/assets/js/6.6172cd91.js"><link rel="prefetch" href="/lql-notes/assets/js/7.7226dbec.js"><link rel="prefetch" href="/lql-notes/assets/js/8.ea6433f4.js"><link rel="prefetch" href="/lql-notes/assets/js/9.a814692c.js"><link rel="prefetch" href="/lql-notes/assets/js/vendors~flowchart.c35ddcb3.js"><link rel="prefetch" href="/lql-notes/assets/js/vendors~mermaid.470ef663.js">
    <link rel="stylesheet" href="/lql-notes/assets/css/0.styles.ea6535aa.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/lql-notes/" class="home-link router-link-active"><img src="https://cdn.staticaly.com/gh/eryajf/tu/main/img/image_20220720_132208.png" alt="lql-notes" class="logo"> <span class="site-name can-hide">lql-notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lql-notes/" class="nav-link">首页</a></div><div class="nav-item"><a href="/lql-notes/java/" class="nav-link">java</a></div><div class="nav-item"><a href="/lql-notes/other/" class="nav-link">other</a></div><div class="nav-item"><a href="/lql-notes/three/" class="nav-link">three</a></div><div class="nav-item"><a href="/lql-notes/message-board/" class="nav-link">留言板</a></div><div class="nav-item"><a href="https://wiki.eryajf.net" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/eryajf/lql-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/lql-notes/" class="nav-link">首页</a></div><div class="nav-item"><a href="/lql-notes/java/" class="nav-link">java</a></div><div class="nav-item"><a href="/lql-notes/other/" class="nav-link">other</a></div><div class="nav-item"><a href="/lql-notes/three/" class="nav-link">three</a></div><div class="nav-item"><a href="/lql-notes/message-board/" class="nav-link">留言板</a></div><div class="nav-item"><a href="https://wiki.eryajf.net" target="_blank" rel="noopener noreferrer" class="nav-link external">
  我的博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/eryajf/lql-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/lql-notes/pages/24768e/" class="sidebar-link">三步上篮配置文档</a></li><li><a href="/lql-notes/pages/24768e1/" class="sidebar-link">Java 函数式编程</a></li><li><a href="/lql-notes/pages/0820a8/" class="sidebar-link">计算机网络</a></li><li><a href="/lql-notes/pages/0baafa/" class="sidebar-link">函数式编程术语</a></li><li><a href="/lql-notes/pages/9aecea/" class="sidebar-link">JAVA中的Stream</a></li><li><a href="/lql-notes/pages/aa885e/" class="sidebar-link">Lambdas 使用</a></li><li><a href="/lql-notes/pages/b7f334/" class="sidebar-link">redis-sds</a></li><li><a href="/lql-notes/pages/6d2513/" class="sidebar-link">Sentinel 源码解析</a></li><li><a href="/lql-notes/pages/601cfa/" aria-current="page" class="active sidebar-link">Spring Security 请求全过程解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/lql-notes/pages/601cfa/#开启-spring-security" class="sidebar-link">开启 Spring Security</a></li><li class="sidebar-sub-header level2"><a href="/lql-notes/pages/601cfa/#基本原理" class="sidebar-link">基本原理</a></li><li class="sidebar-sub-header level2"><a href="/lql-notes/pages/601cfa/#参考" class="sidebar-link">参考</a></li><li class="sidebar-sub-header level2"><a href="/lql-notes/pages/601cfa/#配置自定义登录页" class="sidebar-link">配置自定义登录页</a></li><li class="sidebar-sub-header level2"><a href="/lql-notes/pages/601cfa/#配置用户信息的获取逻辑" class="sidebar-link">配置用户信息的获取逻辑</a></li><li class="sidebar-sub-header level2"><a href="/lql-notes/pages/601cfa/#源码解析" class="sidebar-link">源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/lql-notes/pages/601cfa/#browserconfig-配置解析" class="sidebar-link">BrowserConfig 配置解析</a></li><li class="sidebar-sub-header level3"><a href="/lql-notes/pages/601cfa/#login-html-路径解析" class="sidebar-link">login.html 路径解析</a></li><li class="sidebar-sub-header level3"><a href="/lql-notes/pages/601cfa/#userdetailservice-配置解析" class="sidebar-link">UserDetailService 配置解析</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/lql-notes/pages/601cfa/#参考-2" class="sidebar-link">参考</a></li></ul></li><li><a href="/lql-notes/pages/67ed44/" class="sidebar-link">Tomcat--Servlet 基础源码</a></li><li><a href="/lql-notes/pages/d66c8c/" class="sidebar-link">优雅整洁的 Java 代码命名技巧</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/lql-notes/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>java</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/eryajf" target="_blank" title="作者" class="beLink" data-v-06225672>故梦</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-08-16</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Spring Security 请求全过程解析<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="spring-security-请求全过程解析"><a href="#spring-security-请求全过程解析" class="header-anchor">#</a> Spring Security 请求全过程解析</h1> <p>Spring Security 是一款基于 Spring 的安全框架，主要包含认证和授权两大安全模块，和另外一款流行的安全框架 Apache Shiro 相比，它拥有更为强大的功能。Spring Security 也可以轻松的自定义扩展以满足各种需求，并且对常见的 Web 安全攻击提供了防护支持。如果你的 Web 框架选择的是 Spring，那么在安全方面 Spring Security 会是一个不错的选择。</p> <p>这里我们使用 Spring Boot 来集成 Spring Security，Spring Boot 版本为**<em>2.5.3</em><strong>，Spring Security 版本为</strong><em>5.5.1</em>**。</p> <h2 id="开启-spring-security"><a href="#开启-spring-security" class="header-anchor">#</a> 开启 Spring Security</h2> <p>使用 IDEA 创建一个 Spring Boot 项目，然后引入**<em>spring-boot-starter-security</em>**：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>dependencies <span class="token punctuation">{</span>
    implementation 'org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">:</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>security'
    implementation 'org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">:</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>web'
    implementation 'org<span class="token punctuation">.</span>projectlombok<span class="token operator">:</span>lombok<span class="token operator">:</span><span class="token number">1.18</span><span class="token number">.8</span>'
    annotationProcessor 'org<span class="token punctuation">.</span>projectlombok<span class="token operator">:</span>lombok<span class="token operator">:</span><span class="token number">1.18</span><span class="token number">.8</span>'
    providedRuntime 'org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">:</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>tomcat'
    testImplementation 'org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">:</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>test'
    testImplementation 'org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token operator">:</span>spring<span class="token operator">-</span>security<span class="token operator">-</span>test'
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来我们创建一个**<em>HelloController</em>**，对外提供一个<strong><i>/hello</i></strong>服务：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这时候我们直接启动项目，访问<strong><i>http://localhost:8080/hello</i></strong>，可以看到页面跳转到一个登陆页面：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091508157-8412be.png" alt="image-20210811091508157"></p> <p>默认的用户名为 user，密码由 Sping Security 自动生成，回到 IDEA 的控制台，可以找到密码信息：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Using</span> generated security password<span class="token operator">:</span> <span class="token number">4f</span><span class="token number">06</span>ba04<span class="token operator">-</span><span class="token number">37e9</span><span class="token operator">-</span><span class="token number">4</span>bdd<span class="token operator">-</span>a085<span class="token operator">-</span><span class="token number">3305260d</span>a0d6
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>输入用户名 user，密码 4f06ba04-37e9-4bdd-a085-3305260da0d6 后，我们便可以成功访问<strong><i>/hello</i></strong>接口。</p> <h2 id="基本原理"><a href="#基本原理" class="header-anchor">#</a> 基本原理</h2> <p>Spring Security 默认为我们开启了一个简单的安全配置，下面让我们来了解其原理。</p> <p>当 Spring Boot 项目配置了 Spring Security 后，Spring Security 的整个加载过程如下图所示：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091633434-aac2de.png" alt="image-20210811091633434"></p> <p>而当我们访问<strong><i>http://localhost:8080/hello</i></strong>时，代码的整个执行过程如下图所示：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091659121-2e2f8d.png" alt="image-20210811091659121"></p> <p>如上图所示，Spring Security 包含了众多的过滤器，这些过滤器形成了一条链，所有请求都必须通过这些过滤器后才能成功访问到资源。</p> <p>下面我们通过 debug 来验证这个过程：</p> <p>首先，通过前面可以知道，当有请求来到时，最先由**<em>DelegatingFilterProxy</em><strong>负责接收，因此在</strong><em>DelegatingFilterProxy</em>**的<strong><i>doFilter()</i></strong>的首行打上断点：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091719470-694712.png" alt="image-20210811091719470"></p> <p>接着**<em>DelegatingFilterProxy</em><strong>会将请求委派给</strong><em>FilterChainProxy</em><strong>进行处理，在</strong><em>FilterChainProxy</em>**的首行打上断点：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/56ac5128-eab7-4b92-912f-ff50bac68a4f-711b08.png" alt="img"></p> <p>**<em>FilterChainProxy</em><strong>会在<strong><i>doFilterInternal()</i></strong>中生成一个内部类</strong><em>VirtualFilterChain</em><strong>的实例，以此来调用 Spring Security 的整条过滤器链，在</strong><em>VirtualFilterChain</em>**的<strong><i>doFilter()</i></strong>首行打上断点：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091755498-1bf6b1.png" alt="image-20210811091755498"></p> <p>接下来**<em>VirtualFilterChain</em><strong>会通过</strong><em>currentPosition</em><strong>依次调用存在</strong><em>additionalFilters</em><strong>中的过滤器，其中比较重要的几个过滤器有：</strong><em>UsernamePasswordAuthenticationFilter</em><strong>、</strong><em>DefaultLoginPageGeneratingFilter</em><strong>、</strong><em>AnonymousAuthenticationFilter</em><strong>、</strong><em>ExceptionTranslationFilter</em><strong>、</strong><em>FilterSecurityInterceptor</em>**，我们依次在这些过滤器的<strong><i>doFilter()</i></strong>的首行打上断点：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091815473-2eca01.png" alt="image-20210811091815473"></p> <p>准备完毕后，我们启动项目，然后访问<strong><i>http://localhost:8080/hello</i></strong>，程序首先跳转到**<em>DelegatingFilterProxy</em>**的断点上：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091833065-85d41e.png" alt="image-20210811091833065"></p> <p>此时**<em>delegate</em><strong>还是 null 的，接下来依次执行代码，可以看到</strong><em>delegate</em><strong>最终被赋值一个</strong><em>FilterChainProxy</em>**的实例：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/f045b025-bd97-4222-8a02-51634be6745b-3fc9b3.png" alt="img"></p> <p>接下来程序依次跳转到**<em>FilterChainProxy</em><strong>的<strong><i>doFilter()</i></strong>和</strong><em>VirtualFilterChain</em>**的<strong><i>doFilter()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/90d3e369-510f-45cb-982d-241d2eedb55c-c6ca6e.png" alt="img"></p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811092048784-60b58b.png" alt="image-20210811092048784"></p> <p>接着程序跳转到**<em>AbstractAuthenticationProcessingFilter</em><strong>（</strong><em>UsernamePasswordAuthenticationFilter</em>**的父类）的<strong><i>doFilter()</i></strong>中，通过<strong><i>requiresAuthentication()</i></strong>判定为 false（是否是 POST 请求）：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/2e5440bc-9488-4213-a030-0d25153bb2ea-4df00a.png" alt="img"></p> <p>接着程序跳转到**<em>DefaultLoginPageGeneratingFilter</em>**的<strong><i>doFilter()</i></strong>中，通过<strong><i>isLoginUrlRequest()</i></strong>判定为 false（请求路径是否是<strong><i>/login</i></strong>）：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/47a7bca4-d858-4cb1-b126-347805b74053-80ca77.png" alt="img"></p> <p>接着程序跳转到**<em>AnonymousAuthenticationFilter</em><strong>的<strong><i>doFilter()</i></strong>中，由于是首次请求，此时<strong><i>SecurityContextHolder.getContext().getAuthentication()</i></strong>为 null，因此会生成一个</strong><em>AnonymousAuthenticationToken</em>**的实例：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6b1aded6-5229-47ba-b192-78a7c2622b8c-8ed4e0.png" alt="img"></p> <p>接着程序跳转到**<em>ExceptionTranslationFilter</em><strong>的<strong><i>doFilter()</i></strong>中，</strong><em>ExceptionTranslationFilter</em><strong>负责处理</strong><em>FilterSecurityInterceptor</em>**抛出的异常，我们在 catch 代码块的首行打上断点：</p> <p><strong><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/8efa0b1c-2b32-4d5b-9655-985374326e10-2c5fcb.png" alt="img"></strong></p> <p>接着程序跳转到**<em>FilterSecurityInterceptor</em><strong>的<strong><i>doFilter()</i></strong>中，依次执行代码后程序停留在其父类(</strong><em>AbstractSecurityInterceptor</em>**)的<strong><i>attemptAuthorization()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/d6e99143-6207-43a5-8d04-f0c81baa11b4-c43162.png" alt="img"></p> <p><strong><em>accessDecisionManager</em><strong>是</strong><em>AccessDecisionManager</em></strong>(访问决策器)的实例，<strong><em>AccessDecisionManager</em><strong>主要有 3 个实现类：</strong><em>AffirmativeBased</em></strong>(一票通过)，<strong>ConsensusBased</strong>(少数服从多数)、UnanimousBased(一票否决)，此时**<em>AccessDecisionManager</em><strong>的的实现类是</strong><em>AffirmativeBased</em><strong>，我们可以看到程序进入</strong><em>AffirmativeBased</em>**的<strong><i>decide()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6724647c-34ee-4a57-8cfa-b46f57400d14-722c30.png" alt="img"></p> <p>从上图可以看出，决策的关键在<strong><i>voter.vote(authentication, object, configAttributes)</i></strong>这句代码上，通过跟踪调试，程序最终进入**<em>AuthenticationTrustResolverImpl</em>**的<strong><i>isAnonymous()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/4beaa02f-a93d-4d95-9ad1-0d7213cb0e46-af72e9.png" alt="img"></p> <p><strong><i>isAssignableFrom()</i></strong>判断前者是否是后者的父类，而**<em>anonymousClass</em><strong>被固定为</strong><em>AnonymousAuthenticationToken.class</em><strong>，参数</strong><em>authentication</em><strong>由前面</strong><em>AnonymousAuthenticationFilter</em><strong>可以知道是</strong><em>AnonymousAuthenticationToken</em><strong>的实例，因此<strong><i>isAnonymous()</i></strong>返回 true，</strong><em>FilterSecurityInterceptor</em><strong>抛出</strong><em>AccessDeniedException</em><strong>异常，程序返回</strong><em>ExceptionTranslationFilter</em>**的 catch 块中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/8e1ac9db-5987-484d-abf4-4c6535c60cc6-dd455f.png" alt="img"></p> <p>接着程序会依次进入**<em>DelegatingAuthenticationEntryPoint</em><strong>、</strong><em>LoginUrlAuthenticationEntryPoint</em><strong>中，最后由</strong><em>LoginUrlAuthenticationEntryPoint</em>**的<strong><i>commence()</i></strong>决定重定向到<strong><i>/login</i></strong>：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1b03bdd4-6773-4b39-a664-fdf65d104403-fea7bd.png" alt="img"></p> <p>后续对<strong><i>/login</i></strong>的请求同样会经过之前的执行流程，在**<em>DefaultLoginPageGeneratingFilter</em><strong>的<strong><i>doFilter()</i></strong>中，通过<strong><i>isLoginUrlRequest()</i></strong>判定为 true（请求路径是否是<strong><i>/login</i></strong>）,直接返回</strong><em>login.html</em>**，也就是我们开头看到的登录页面。</p> <p>当我们输入用户名和密码，点击**<em>Sign in</em><strong>，程序来到</strong><em>AbstractAuthenticationProcessingFilter</em><strong>的<strong><i>doFilter()</i></strong>中，通过<strong><i>requiresAuthentication()</i></strong>判定为 true（是否是 POST 请求）,因此交给其子类</strong><em>UsernamePasswordAuthenticationFilter</em><strong>进行处理，</strong><em>UsernamePasswordAuthenticationFilter</em><strong>会将用户名和密码封装成一个</strong><em>UsernamePasswordAuthenticationToken</em>**的实例并进行校验，当校验通过后会将请求重定向到我们一开始请求的路径：<strong><i>/hello</i></strong>。</p> <p>后续对<strong><i>/hello</i></strong>的请求经过过滤器链时就可以一路开绿灯直到最终交由**<em>HelloController</em>**返回&quot;Hello World&quot;。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ol><li><p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/" target="_blank" rel="noopener noreferrer">Spring Security Reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://mrbird.cc/Spring-Boot&amp;Spring-Security.html" target="_blank" rel="noopener noreferrer">Spring Boot 中开启 Spring Security<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ol> <h1 id="spring-security-自定义用户认证"><a href="#spring-security-自定义用户认证" class="header-anchor">#</a> Spring Security 自定义用户认证</h1> <p>在<strong>Spring Boot 中开启 Spring Security</strong>一节中我们简单地搭建了一个 Spring Boot + Spring Security 的项目，其中登录页、用户名和密码都是由 Spring Security 自动生成的。Spring Security 支持我们自定义认证的过程，如使用自定义的登录页替换默认的登录页，用户信息的获取逻辑、登录成功或失败后的处理逻辑等。这里将在上一节的源码基础上进行改造。</p> <h2 id="配置自定义登录页"><a href="#配置自定义登录页" class="header-anchor">#</a> 配置自定义登录页</h2> <p>为了方便起见，我们直接在<strong><i>src/main/resources/resources</i></strong>目录下创建一个<strong><i>login.html</i></strong>（不需要 Controller 跳转）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;登录&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/login.css&quot; type=&quot;text/css&quot;&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form class=&quot;login-page&quot; action=&quot;/login&quot; method=&quot;post&quot;&gt;
        &lt;div class=&quot;form&quot;&gt;
            &lt;h3&gt;账户登录&lt;/h3&gt;
            &lt;input type=&quot;text&quot; placeholder=&quot;用户名&quot; name=&quot;username&quot; required=&quot;required&quot; /&gt;
            &lt;input type=&quot;password&quot; placeholder=&quot;密码&quot; name=&quot;password&quot; required=&quot;required&quot; /&gt;
            &lt;button type=&quot;submit&quot;&gt;登录&lt;/button&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>要怎么做才能让 Spring Security 跳转到我们自己定义的登录页面呢？很简单，只需要在<strong><i>BrowserSecurityConfig</i></strong>的<strong><i>configure</i></strong>中添加一些配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Configuration
public class BrowserConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.formLogin() // 表单登录
                .loginPage(&quot;/login.html&quot;) // 自定义登录页
                .loginProcessingUrl(&quot;/login&quot;) // 登录认证路径
                .and()
                .authorizeRequests() // 授权配置
                .antMatchers(&quot;/login.html&quot;, &quot;/css/&lt;/strong&gt;&lt;/i&gt;&quot;, &quot;/error&quot;).permitAll() // 无需认证
                .anyRequest().authenticated() // 除antMatchers中配置路径外其他所有请求都需要认证
                .and().csrf().disable();
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>上面代码中<strong><i>.loginPage(&quot;/login.html&quot;)</i></strong>指定了跳转到登录页面的请求 URL，<strong><i>.loginProcessingUrl(&quot;/login&quot;)</i></strong>对应登录页面 form 表单的<strong><i>action=&quot;/login&quot;</i></strong>，<strong><i>.antMatchers(&quot;/login.html&quot;, &quot;/css/&quot;, &quot;/error&quot;).permitAll()</i></strong>表示跳转到登录页面的请求不被拦截。</p> <p>这时候启动系统，访问<strong><i>http://localhost:8080/hello</i></strong>，会看到页面已经被重定向到了<strong><i>http://localhost:8080/login.html</i></strong>：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/d6bd19a2-08d3-4ba6-921c-5b5f57370a16-ed99eb.jpg" alt="img"></p> <h2 id="配置用户信息的获取逻辑"><a href="#配置用户信息的获取逻辑" class="header-anchor">#</a> 配置用户信息的获取逻辑</h2> <p>Spring Security 默认会为我们生成一个用户名为 user，密码随机的用户实例，当然我们也可以定义自己用户信息的获取逻辑，只需要实现 Spring Security 提供的**<em>UserDetailService</em><strong>接口即可，该接口只有一个抽象方法</strong><em>loadUserByUsername</em>**，具体实现如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Service
public class UserDetailService implements UserDetailsService {
    @Autowired
    private PasswordEncoder passwordEncoder;
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        return new User(username, passwordEncoder.encode(&quot;123456&quot;), AuthorityUtils.createAuthorityList(&quot;admin&quot;));
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>通过以上配置，我们定义了一个用户名随机，密码统一为 123456 的用户信息的获取逻辑。这样，当我们启动项目，访问<strong><i>http://localhost:8080/login</i></strong>，只需要输入任意用户名以及 123456 作为密码即可登录系统。</p> <h2 id="源码解析"><a href="#源码解析" class="header-anchor">#</a> 源码解析</h2> <h3 id="browserconfig-配置解析"><a href="#browserconfig-配置解析" class="header-anchor">#</a> BrowserConfig 配置解析</h3> <p>我们首先来梳理下<strong><i>BrowserConfig</i></strong>中的配置是如何被 Spring Security 所加载的。</p> <p>首先找到调用<strong><i>BrowserConfig</i></strong>的<strong><i>configure()</i></strong>的地方，在其父类<strong><i>WebSecurityConfigurerAdapter</i></strong>的<strong><i>getHttp()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/12629a18-56ef-4286-9ab9-c124dc3d6791-d5ce43.png" alt="img"></p> <p>往上一步找到调用<strong><i>getHttp()</i></strong>的地方，在同个类的<strong><i>init()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/2b54af34-7d68-4f40-8726-d02d18e03dea-89264f.png" alt="img"></p> <p>往上一步找到调用<strong><i>init()</i></strong>的地方，在<strong><i>AbstractConfiguredSecurityBuilder</i></strong>的<strong><i>init()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6e009bf1-aba3-4b89-8e86-d3d110e0f4a7-0b5c99.png" alt="img"></p> <p>在<strong><i>init()</i></strong>被调用时，它首先会遍历<strong><i>getConfigurers()</i></strong>返回的集合中的元素，调用其<strong><i>init()</i></strong>，点击<strong><i>getConfigurers()</i></strong>查看，发现其读取的是<strong><i>configurers</i></strong>属性的值，那么<strong><i>configurers</i></strong>是什么时候被赋值的呢？我们在同个类的<strong><i>add()</i></strong>中找到<strong><i>configurers</i></strong>被赋值的代码：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ed65fd2a-8a9f-4808-bc16-36128b4af47a-f7e589.png" alt="img"></p> <p>往上一步找到调用<strong><i>add()</i></strong>的地方，在同个类的<strong><i>apply()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1e929fec-d1ab-44b5-89bc-6e5ebcda1daf-783836.png" alt="img"></p> <p>往上一步找到调用<strong><i>apply()</i></strong>的地方，在<strong><i>WebSecurityConfiguration</i></strong>的<strong><i>setFilterChainProxySecurityConfigurer()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1840f96a-6a31-4fce-8a98-02fa7fc60fbf-04df5b.png" alt="img"></p> <p>我们可以看到，在<strong><i>setFilterChainProxySecurityConfigurer()</i></strong>中，首先会实例化一个<strong><i>WebSecurity</i></strong>（<strong><i>AbstractConfiguredSecurityBuilder</i></strong>的实现类）的实例，遍历参数<strong><i>webSecurityConfigurers</i></strong>，将存储在其中的元素作为参数传递给<strong><i>WebSecurity</i></strong>的<strong><i>apply()</i></strong>，那么<strong><i>webSecurityConfigurers</i></strong>是什么时候被赋值的呢？我们根据<strong><i>@Value</i></strong>中的信息找到<strong><i>webSecurityConfigurers</i></strong>被赋值的地方，在<strong><i>AutowiredWebSecurityConfigurersIgnoreParents</i></strong>的<strong><i>getWebSecurityConfigurers()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/eb7a5916-4049-4682-9a11-10f1f1f94c74-c2bc42.png" alt="img"></p> <p>我们重点看第二句代码，可以看到这里会提取存储在 bean 工厂中类型为<strong><i>WebSecurityConfigurer.class</i></strong>的 bean，而<strong><i>BrowserConfig</i></strong>正是<strong><i>WebSecurityConfigurerAdapter</i></strong>的实现类。</p> <p>解决完<strong><i>configurers</i></strong>的赋值问题，我们回到<strong><i>AbstractConfiguredSecurityBuilder</i></strong>的<strong><i>init()</i></strong>处，找到调用该方法的地方，在同个类的<strong><i>doBuild()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/522574e3-bacc-4794-a17e-492bc2b4457d-b07011.png" alt="img"></p> <p>往上一步找到调用<strong><i>doBuild()</i></strong>的地方，在<strong><i>AbstractSecurityBuilder</i></strong>的<strong><i>build()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/fb22f2ca-3d9a-420f-b77a-f9c0f737d9ad-60dcd2.png" alt="img"></p> <p>往上一步找到调用<strong><i>doBuild()</i></strong>的地方，在<strong><i>WebSecurityConfiguration</i></strong>的<strong><i>springSecurityFilterChain()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/a5c61feb-ca72-4768-94bd-1b0a8cf8af70-fbe06b.png" alt="img"></p> <p>至此，我们分析完了<strong><i>BrowserConfig</i></strong>被 Spring Security 加载的过程。现在我们再来看看当我们自定义的配置被加载完后，<strong><i>http</i></strong>各属性的变化，在<strong><i>BrowserConfig</i></strong>的<strong><i>configure()</i></strong>末尾打上断点，当程序走到断点处时，查看<strong><i>http</i></strong>属性：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6c72c09b-742c-4415-851a-8ca5292a4969-f39334.png" alt="img"></p> <p>我们配置的<strong><i>.loginPage(&quot;/login.html&quot;)</i></strong>和<strong><i>.loginProcessingUrl(&quot;/login&quot;)</i></strong>在<strong><i>FormLoginConfigurer</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/51ba02f0-bae6-4c08-9adf-7ee0f12b05d3-041ec9.png" alt="img"></p> <p>配置的<strong><i>.antMatchers(&quot;/login.html&quot;, &quot;/css/&quot;, &quot;/error&quot;).permitAll()</i></strong>在<strong><i>ExpressionUrlAuthorizationConfigurer</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/52390725-d87d-42b1-9071-ea21e445e1e6-c76af1.png" alt="img"></p> <p>这样，当我们访问除<strong><i>&quot;/login.html&quot;, &quot;/css/&quot;, &quot;/error&quot;</i></strong>以外的路径时，在<strong><i>AbstractSecurityInterceptor</i></strong>（<strong><i>FilterSecurityInterceptor</i></strong>的父类）的<strong><i>attemptAuthorization()</i></strong>中会抛出<strong><i>AccessDeniedException</i></strong>异常（最终由<strong><i>AuthenticationTrustResolverImpl</i></strong>的<strong>isAnonymous()</strong>进行判断）</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/558b8b1c-be32-44c4-8d8f-5f0d231741f8-e4e13c.png" alt="img"></p> <p>当我们访问<strong><i>&quot;/login.html&quot;, &quot;/css/&quot;, &quot;/error&quot;</i></strong>这几个路径时，在<strong><i>AbstractSecurityInterceptor</i></strong>（<strong><i>FilterSecurityInterceptor</i></strong>的父类）的<strong><i>attemptAuthorization()</i></strong>中正常执行（最终由<strong><i>SecurityExpressionRoot</i></strong>的<strong><i>permitAll()</i></strong>进行判断）</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/4612c27e-dd9f-4e60-92dc-fc9858496ec5-cb532b.png" alt="img"></p> <h3 id="login-html-路径解析"><a href="#login-html-路径解析" class="header-anchor">#</a> login.html 路径解析</h3> <p>当我们请求的资源需要经过认证时，Spring Security 会将请求重定向到我们自定义的登录页，那么 Spring 又是如何找到我们自定义的登录页的呢？下面就让我们来解析一下：</p> <p>我们首先来到<strong><i>DispatcherServlet</i></strong>中，<strong><i>DispatcherServlet</i></strong>是 Spring Web 处理请求的入口。当 Spring Web 项目启动后，第一次接收到请求时，会调用其<strong><i>initStrategies()</i></strong>进行初始化：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/964ec4a4-6039-4205-8a87-ea2febcc00b6-3d24d5.png" alt="img"></p> <p>我们重点关注<strong><i>initHandlerMappings(context);</i></strong>这句，<strong><i>initHandlerMappings()</i></strong>用于初始化处理器映射器（处理器映射器可以根据请求找到对应的资源），我们来到<strong><i>initHandlerMappings()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/0a97b011-34ed-4d57-945e-95c8e6bafc8e-b26642.png" alt="img"></p> <p>可以看到，当程序走到<strong><i>initHandlerMappings()</i></strong>中时，会从 bean 工厂中找出<strong><i>HandlerMapping.class</i></strong>类型的 bean，将其存储到<strong><i>handlerMappings</i></strong>属性中。这里看到一共找到 5 个，分别是：<strong><i>requestMappingHandlerMapping</i></strong>（将请求与标注了<strong><i>@RequestMapping</i></strong>的方法进行关联）、<strong><i>weclomePageHandlerMapping</i></strong>（将请求与主页进行关联）、<strong><i>beanNameHandlerMapping</i></strong>（将请求与同名的 bean 进行关联）、<strong><i>routerFunctionMapping</i></strong>（将请求与<strong><i>RouterFunction</i></strong>进行关联）、<strong><i>resourceHandlerMapping</i></strong>（将请求与静态资源进行关联），这 5 个 bean 是在<strong><i>WebMvcAutoConfiguration$EnableWebMvcConfiguration</i></strong>中配置的：</p> <p><strong><i>requestMappingHandlerMapping:</i></strong></p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/cd7aee86-66f8-4197-99d1-1c9275e33bee-fe5fff.png" alt="img"></p> <p><strong><i>weclomePageHandlerMapping:</i></strong></p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ef28372b-de89-46ff-8679-8b8feca04a7a-d48d4f.png" alt="img"></p> <p><strong><i>beanNameHandlerMapping</i></strong>、<strong><i>routerFunctionMapping</i></strong>、<strong><i>resourceHandlerMapping</i></strong>在<strong><i>EnableWebMvcConfiguration</i></strong>的父类（<strong><i>WebMvcConfigurationSupport</i></strong>）中配置：</p> <p><strong><i>beanNameHandlerMapping:</i></strong></p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/8d05ac54-f034-47d4-b750-67b2e3b3cd14-79ea81.png" alt="img"></p> <p><strong><i>routerFunctionMapping:</i></strong></p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/481b88aa-028d-4392-8c0a-365f1d0e2ae9-10387b.png" alt="img"></p> <p><strong><i>resourceHandlerMapping:</i></strong></p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/fcdab503-2735-46bd-a5b6-226dc348e78c-97f6ca.png" alt="img"></p> <p>我们将目光锁定在<strong><i>resourceHandlerMapping</i></strong>上，当<strong><i>resourceHandlerMapping</i></strong>被初始化时，会调用<strong><i>addResourceHandlers()</i></strong>为<strong><i>registry</i></strong>添加资源处理器，我们找到实际被调用的<strong><i>addResourceHandlers()</i></strong>，在<strong><i>DelegatingWebMvcConfiguration</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6eca7b58-80f9-4e98-8483-62b4ef751854-7a802c.png" alt="img"></p> <p>可以看到这里实际调用的是<strong><i>configurers</i></strong>属性的<strong><i>addResourceHandlers()</i></strong>，而<strong><i>configurers</i></strong>是一个 final 类型的成员变量，其值是<strong><i>WebMvcConfigurerComposite</i></strong>的实例，我们来到<strong><i>WebMvcConfigurerComposite</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/c365e5ab-a7a3-4ebf-8a25-09cd2e049f22-1393ac.png" alt="img"></p> <p>可以看到这里实际调用的是<strong><i>delegates</i></strong>属性的<strong><i>addResourceHandlers()</i></strong>，<strong><i>delegates</i></strong>是一个 final 类型的集合，集合的元素由<strong><i>addWebMvcConfigurers()</i></strong>负责添加：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/895afead-ea6b-4ac6-8138-fbe0a223daf9-2b3a9d.png" alt="img"></p> <p>我们找到调用<strong><i>addWebMvcConfigurers()</i></strong>的地方，在<strong><i>DelegatingWebMvcConfiguration</i></strong>的<strong><i>setConfigurers()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/a20e06a4-5a43-4edf-bea1-53fc9bc929e9-9eed17.png" alt="img"></p> <p>可以看到当<strong><i>setConfigurers()</i></strong>被初始化时，Spring 会往参数<strong><i>configurers</i></strong>中传入两个值，我们关注第一个值，是一个<strong><i>WebMvcAutoConfiguration<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mi>e</mi><mi>b</mi><mi>M</mi><mi>v</mi><mi>c</mi><mi>A</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>A</mi><mi>d</mi><mi>a</mi><mi>p</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>&lt;</mo><mi mathvariant="normal">/</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>n</mi><mi>g</mi><mo>&gt;</mo><mo>&lt;</mo><mi mathvariant="normal">/</mi><mi>i</mi><mo>&gt;</mo><mtext>的实例，注意它的属性</mtext><mo>&lt;</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>n</mi><mi>g</mi><mo>&gt;</mo><mo>&lt;</mo><mi>i</mi><mo>&gt;</mo><mi>r</mi><mi>e</mi><mi>s</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>c</mi><mi>e</mi><mi>P</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>t</mi><mi>i</mi><mi>e</mi><mi>s</mi><mo>&lt;</mo><mi mathvariant="normal">/</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>n</mi><mi>g</mi><mo>&gt;</mo><mo>&lt;</mo><mi mathvariant="normal">/</mi><mi>i</mi><mo>&gt;</mo><mtext>，是一个</mtext><mo>&lt;</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>n</mi><mi>g</mi><mo>&gt;</mo><mo>&lt;</mo><mi>i</mi><mo>&gt;</mo><mi>W</mi><mi>e</mi><mi>b</mi><mi>P</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>t</mi><mi>i</mi><mi>e</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">WebMvcAutoConfigurationAdapter&lt;/strong&gt;&lt;/i&gt;的实例，注意它的属性&lt;strong&gt;&lt;i&gt;resourceProperties&lt;/strong&gt;&lt;/i&gt;，是一个&lt;strong&gt;&lt;i&gt;WebProperties</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal">e</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">c</span><span class="mord mathnormal">A</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">gu</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">A</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">pt</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord cjk_fallback">的实例，注意它的属性</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">reso</span><span class="mord mathnormal">u</span><span class="mord mathnormal">rce</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">es</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord cjk_fallback">，是一个</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal">e</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">es</span></span></span></span>Resources</i></strong>的实例，默认情况下，在实例化<strong><i>WebMvcAutoConfigurationAdapter</i></strong>时，由传入参数<strong><i>webProperties</i></strong>进行赋值：<strong><i>webProperties.getResources()</i></strong>：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/97b6f22c-414d-4a16-aa8e-c3deece2f7cd-e7ca3d.png" alt="img"></p> <p>我们进入参数<strong><i>webProperties</i></strong>的类中，可以看到<strong><i>getResources()</i></strong>是直接实例化了一个<strong><i>Resources</i></strong>，其属性<strong><i>staticLocations</i></strong>是一个含有 4 个值的 final 类型的字符串数组，这 4 个值正是 Spring 寻找静态文件的地方：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/4d84fe43-2646-4a6f-a580-f39f6416d02d-db197a.png" alt="img"></p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/25899949-dac3-4873-a2af-7abfe0e97615-cc8d89.png" alt="img"></p> <p>我们回到<strong><i>WebMvcAutoConfiguration</i></strong>的<strong><i>addResourceHandlers()</i></strong>中：<img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/003ff2fa-022e-47cb-8aa9-343ed7c40c4a-40568a.png" alt="img"></p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ccd16b38-d724-4c03-949e-3b6ba03268a9-e6d109.png" alt="img"></p> <p>在<strong><i>addResourceHandlers()</i></strong>中，会为<strong><i>registry</i></strong>添加两个资源处理器，当请求路径是“/webjars/”时，会在”classpath:/META-INF/resources/webjars/“路径下寻找对应的资源，当请求路径是“/**”时，会在”classpath:/META-INF/resources/“、”classpath:/resources/“、”classpath:/static/“、”classpath:/public/“路径下寻找对应的资源。</p> <p>现在我们通过访问<strong><i>http://localhost:8080/login.html</i></strong>来验证这个过程。</p> <p>请求首先来到<strong><i>DispatcherServlet</i></strong>的<strong><i>doDispatch()</i></strong>中，由于是对静态资源的请求，当程序走到<strong><i>mappedHandler = getHandler(processedRequest);</i></strong>时，通过<strong><i>getHandler()</i></strong>返回<strong><i>SimpleUrlHandlerMapping</i></strong>（即<strong><i>resourceHandlerMapping</i></strong>的类型）的<strong><i>HandlerExecutionChain</i></strong>：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/4c9c302d-2ce0-4b5b-beb6-c76d2e94038f-6114ba.png" alt="img"></p> <p>然后由实际的处理器进行处理：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1590bae4-2e3a-4f97-b02d-d918c49cac22-3f264e.png" alt="img"></p> <p>程序一路调试，来到<strong><i>ResourceHttpRequestHandler</i></strong>的<strong><i>handleRequest()</i></strong>中，通过调用<strong><i>Resource resource = getResource(request);</i></strong>找到请求对应的资源：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/0879e131-da5f-491e-a153-42770ce8b975-2e188c.png" alt="img"></p> <p>而在<strong><i>getResource()</i></strong>中，实际是将请求路径（即<strong><i>login.html</i></strong>）与前面配置的路径进行拼接（组合成<strong><i>/resources/login.html</i></strong>这样的路径），再通过类加载器来寻找资源。</p> <p>后面源码深入过深，就不一一展开了，只截取其中比较重要的几段代码：</p> <p><strong><i>PathResourceResolver</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6c58e27d-dd29-48fc-b597-8067e1c97786-3dba54.png" alt="img"></p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/c7ef78df-c2ab-4f89-b5ad-45561a91ffcc-3bfb65.png" alt="img"></p> <p><strong><i>ClassPathResource</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/42c5125e-0dc2-4c0c-9434-af4a9efd2d5d-ef27fc.png" alt="img"></p> <p><strong><i>ClassLoader</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/7842f83d-5417-4cb2-bb30-d70f98c3053f-e44fa7.png" alt="img"></p> <p><strong><i>URLClassLoader</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/870891e9-f8ea-4097-98c9-829b1cdcf145-4db6b8.png" alt="img"></p> <p>最终，类加载器会在如上两个路径下找到登录页并返回。</p> <h3 id="userdetailservice-配置解析"><a href="#userdetailservice-配置解析" class="header-anchor">#</a> UserDetailService 配置解析</h3> <p>我们定义的用户信息的获取逻辑是如何被 Spring Security 应用的呢？让我们通过阅读源码来了解一下。</p> <p>还记得前面我们讲**<em>BrowserConfig 配置</em><strong>被加载的过程吗？</strong><em>UserDetailService</em><strong>也是在这个过程中被一起加载完成的，回到</strong>BrowserConfig 配置解析**的第一幅图中，如下：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/68490740-e03c-4353-b5fc-ac99c0cf0435-066f58.png" alt="img"></p> <p>在断点处位置，<strong><i>authenticationManager()</i></strong>会返回一个**<em>AuthenticationManager</em>**实例，我们进入<strong><i>authenticationManager()</i></strong>中:</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/e7a1a684-64db-41d0-a5c0-d9a841d86cc1-26b91c.png" alt="img"></p> <p>在<strong><i>authenticationManager()</i></strong>中，**<em>AuthenticationManager</em><strong>转由</strong><em>AuthenticationConfiguration</em>**中获取，我们进入<strong><i>getAuthenticationManager()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/d9ae84ae-d60c-4d9c-a7fd-cddeb1142f95-736c32.png" alt="img"></p> <p>程序来到**<em>AuthenticationConfiguration</em><strong>的<strong><i>getAuthenticationManager()</i></strong>中，</strong><em>AuthenticationManager</em><strong>转由</strong><em>AuthenticationManagerBuilder</em>**中获取，我们进入<strong><i>build()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/19f71152-f456-4db7-a1d5-f79aaa37253b-7df7ee.png" alt="img"></p> <p>程序来到**<em>AbstractConfiguredSecurityBuilder</em><strong>的<strong><i>doBuild()</i></strong>中，这里在构建</strong><em>AuthenticationManager</em><strong>实例时，需要初始化 3 个配置类，我们重点关注第 3 个配置类：</strong><em>org.springframework.security.config.annotation.authentication.configuration.InitializeUserDetailsBeanManagerConfigurer</em><strong>，这个配置类是在</strong><em>AuthenticationConfiguration</em>**中引入的：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/9f06c823-645d-413b-8bb6-1d81b8f329ea-9c9382.png" alt="img"></p> <p>我们来到**<em>InitializeUserDetailsBeanManagerConfigurer</em>**的<strong><i>init()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/cd7d6cb9-c6e7-4570-aab8-309adcb15e16-8f321c.png" alt="img"></p> <p>这里会新建一个**<em>InitializeUserDetailsManagerConfigurer</em><strong>实例添加到</strong><em>AuthenticationManagerBuilder</em>**中。我们回到<strong><i>doBuild()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/3ea76980-417d-4c0c-9330-e0bb241c6a47-10e5ba.png" alt="img"></p> <p>可以看到配置类变成了 5 个，其中就有刚刚新建的**<em>InitializeUserDetailsManagerConfigurer</em><strong>，程序接下来会调用各个配置类的<strong><i>configure()</i></strong>进行配置，我们来到</strong><em>InitializeUserDetailsManagerConfigurer</em>**的<strong><i>configure()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ec39a9f6-c97d-4b7d-8843-d20358c1d194-0300e2.png" alt="img"></p> <p>可以看到在<strong><i>configure()</i></strong>中，就会去 bean 工厂中寻找**<em>UserDetailsService</em><strong>类型的 bean，若是我们没有自定义</strong><em>UserDetailsService</em><strong>的实现类的话，Spring Security 默认会生成一个</strong><em>InMemoryUserDetailsManager</em>**的实例：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/c6a7370c-4afb-4c5d-aa35-ba9c3406b1ed-27873e.png" alt="img"></p> <p>**<em>InMemoryUserDetailsManager</em><strong>是在</strong><em>UserDetailsServiceAutoConfiguration</em>**类中配置的：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/476f8954-abe3-4e26-bfe1-8c5b4abbf0e0-4e35eb.png" alt="img"></p> <p>解决完**<em>UserDetailsService</em><strong>的加载问题，现在我们来看看 Spring Security 是如何通过</strong><em>UserDetailsService</em>**获取用户信息的。</p> <p>通过<strong>Spring Boot 中开启 Spring Security</strong>一节的学习我们知道，登录判断的逻辑是在**<em>UsernamePasswordAuthenticationFilter</em><strong>中进行的，因此我们在</strong><em>UsernamePasswordAuthenticationFilter</em><strong>的<strong><i>attemptAuthenticatio()</i></strong>中打上断点，然后启动项目，访问登录页，输入用户名和密码点击登录后，程序来到</strong><em>UsernamePasswordAuthenticationFilter</em>**中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1282014b-fc29-4c2b-9316-9fdd638653c9-c57131.png" alt="img"></p> <p>这里将验证的逻辑交由**<em>AuthenticationManager</em>**进行，我们进入<strong><i>authenticate()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/5d511c93-3614-40e0-b3c9-9673c573d60f-780220.png" alt="img"></p> <p>程序来到**<em>ProviderManager</em>**的<strong><i>authenticate()</i></strong>中，这里将验证的逻辑委托给其父类进行，再次点击进入<strong><i>authenticate()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/8dddd63e-c567-4b41-a9d9-8ef8aa6f2a92-449014.png" alt="img"></p> <p>这里将验证的逻辑交由**<em>AuthenticationProvider</em>**进行，我们进入<strong><i>authenticate()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ec796a9b-7c65-49a2-9f9f-7685af7bd57b-570d6a.png" alt="img"></p> <p>程序来到**<em>AbstractUserDetailsAuthenticationProvider</em>**的<strong><i>authenticate()</i></strong>中，这里会根据用户名去寻找对应的用户实例，我们进入<strong><i>retrieveUser()</i></strong>中：</p> <p><img src="https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/3980e264-c073-456a-b808-715edd85633a-fbf3c5.png" alt="img"></p> <p>程序来到**<em>DaoAuthenticationProvider</em><strong>的<strong><i>retrieveUser()</i></strong>中，可以看到正是在这里，会从</strong><em>UserDetailsService</em>**的<strong><i>loadUserByUsername()</i></strong>中寻找对应的用户信息。</p> <h2 id="参考-2"><a href="#参考-2" class="header-anchor">#</a> 参考</h2> <ol><li><a href="https://mrbird.cc/Spring-Security-Authentication.html" target="_blank" rel="noopener noreferrer">Spring Security 自定义用户认证<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/eryajf/lql-notes/edit/main/docs/01.java/16.Spring Security 请求全过程解析.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/16/2022, 3:11:15 PM</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/lql-notes/pages/6d2513/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Sentinel 源码解析</div></a> <a href="/lql-notes/pages/67ed44/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Tomcat--Servlet 基础源码</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/lql-notes/pages/6d2513/" class="prev">Sentinel 源码解析</a></span> <span class="next"><a href="/lql-notes/pages/67ed44/">Tomcat--Servlet 基础源码</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="https://github.com/eryajf" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="mailto:eryajf@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://gitee.com/eryajf" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Eryajf </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/lql-notes/assets/js/app.9e66de21.js" defer></script><script src="/lql-notes/assets/js/4.cd41d527.js" defer></script><script src="/lql-notes/assets/js/18.0abab180.js" defer></script>
  </body>
</html>

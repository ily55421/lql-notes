(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{412:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"spring-security-请求全过程解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#spring-security-请求全过程解析"}},[s._v("#")]),s._v(" Spring Security 请求全过程解析")]),s._v(" "),t("p",[s._v("Spring Security 是一款基于 Spring 的安全框架，主要包含认证和授权两大安全模块，和另外一款流行的安全框架 Apache Shiro 相比，它拥有更为强大的功能。Spring Security 也可以轻松的自定义扩展以满足各种需求，并且对常见的 Web 安全攻击提供了防护支持。如果你的 Web 框架选择的是 Spring，那么在安全方面 Spring Security 会是一个不错的选择。")]),s._v(" "),t("p",[s._v("这里我们使用 Spring Boot 来集成 Spring Security，Spring Boot 版本为**"),t("em",[s._v("2.5.3")]),t("strong",[s._v("，Spring Security 版本为")]),t("em",[s._v("5.5.1")]),s._v("**。")]),s._v(" "),t("h2",{attrs:{id:"开启-spring-security"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开启-spring-security"}},[s._v("#")]),s._v(" 开启 Spring Security")]),s._v(" "),t("p",[s._v("使用 IDEA 创建一个 Spring Boot 项目，然后引入**"),t("em",[s._v("spring-boot-starter-security")]),s._v("**：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("dependencies "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    implementation 'org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("boot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("spring"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("boot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("starter"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("security'\n    implementation 'org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("boot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("spring"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("boot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("starter"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("web'\n    implementation 'org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("projectlombok"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("lombok"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.18")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".8")]),s._v("'\n    annotationProcessor 'org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("projectlombok"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("lombok"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.18")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".8")]),s._v("'\n    providedRuntime 'org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("boot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("spring"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("boot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("starter"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("tomcat'\n    testImplementation 'org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("boot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("spring"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("boot"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("starter"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("test'\n    testImplementation 'org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("security"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("spring"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("security"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("test'\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("接下来我们创建一个**"),t("em",[s._v("HelloController")]),s._v("**，对外提供一个"),t("strong",[t("i",[s._v("/hello")])]),s._v("服务：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RestController")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HelloController")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GetMapping")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("hello")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello world"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("这时候我们直接启动项目，访问"),t("strong",[t("i",[s._v("http://localhost:8080/hello")])]),s._v("，可以看到页面跳转到一个登陆页面：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091508157-8412be.png",alt:"image-20210811091508157"}})]),s._v(" "),t("p",[s._v("默认的用户名为 user，密码由 Sping Security 自动生成，回到 IDEA 的控制台，可以找到密码信息：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Using")]),s._v(" generated security password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4f")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("06")]),s._v("ba04"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("37e9")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("bdd"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("a085"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3305260d")]),s._v("a0d6\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("输入用户名 user，密码 4f06ba04-37e9-4bdd-a085-3305260da0d6 后，我们便可以成功访问"),t("strong",[t("i",[s._v("/hello")])]),s._v("接口。")]),s._v(" "),t("h2",{attrs:{id:"基本原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基本原理"}},[s._v("#")]),s._v(" 基本原理")]),s._v(" "),t("p",[s._v("Spring Security 默认为我们开启了一个简单的安全配置，下面让我们来了解其原理。")]),s._v(" "),t("p",[s._v("当 Spring Boot 项目配置了 Spring Security 后，Spring Security 的整个加载过程如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091633434-aac2de.png",alt:"image-20210811091633434"}})]),s._v(" "),t("p",[s._v("而当我们访问"),t("strong",[t("i",[s._v("http://localhost:8080/hello")])]),s._v("时，代码的整个执行过程如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091659121-2e2f8d.png",alt:"image-20210811091659121"}})]),s._v(" "),t("p",[s._v("如上图所示，Spring Security 包含了众多的过滤器，这些过滤器形成了一条链，所有请求都必须通过这些过滤器后才能成功访问到资源。")]),s._v(" "),t("p",[s._v("下面我们通过 debug 来验证这个过程：")]),s._v(" "),t("p",[s._v("首先，通过前面可以知道，当有请求来到时，最先由**"),t("em",[s._v("DelegatingFilterProxy")]),t("strong",[s._v("负责接收，因此在")]),t("em",[s._v("DelegatingFilterProxy")]),s._v("**的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("的首行打上断点：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091719470-694712.png",alt:"image-20210811091719470"}})]),s._v(" "),t("p",[s._v("接着**"),t("em",[s._v("DelegatingFilterProxy")]),t("strong",[s._v("会将请求委派给")]),t("em",[s._v("FilterChainProxy")]),t("strong",[s._v("进行处理，在")]),t("em",[s._v("FilterChainProxy")]),s._v("**的首行打上断点：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/56ac5128-eab7-4b92-912f-ff50bac68a4f-711b08.png",alt:"img"}})]),s._v(" "),t("p",[s._v("**"),t("em",[s._v("FilterChainProxy")]),t("strong",[s._v("会在"),t("strong",[t("i",[s._v("doFilterInternal()")])]),s._v("中生成一个内部类")]),t("em",[s._v("VirtualFilterChain")]),t("strong",[s._v("的实例，以此来调用 Spring Security 的整条过滤器链，在")]),t("em",[s._v("VirtualFilterChain")]),s._v("**的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("首行打上断点：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091755498-1bf6b1.png",alt:"image-20210811091755498"}})]),s._v(" "),t("p",[s._v("接下来**"),t("em",[s._v("VirtualFilterChain")]),t("strong",[s._v("会通过")]),t("em",[s._v("currentPosition")]),t("strong",[s._v("依次调用存在")]),t("em",[s._v("additionalFilters")]),t("strong",[s._v("中的过滤器，其中比较重要的几个过滤器有：")]),t("em",[s._v("UsernamePasswordAuthenticationFilter")]),t("strong",[s._v("、")]),t("em",[s._v("DefaultLoginPageGeneratingFilter")]),t("strong",[s._v("、")]),t("em",[s._v("AnonymousAuthenticationFilter")]),t("strong",[s._v("、")]),t("em",[s._v("ExceptionTranslationFilter")]),t("strong",[s._v("、")]),t("em",[s._v("FilterSecurityInterceptor")]),s._v("**，我们依次在这些过滤器的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("的首行打上断点：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091815473-2eca01.png",alt:"image-20210811091815473"}})]),s._v(" "),t("p",[s._v("准备完毕后，我们启动项目，然后访问"),t("strong",[t("i",[s._v("http://localhost:8080/hello")])]),s._v("，程序首先跳转到**"),t("em",[s._v("DelegatingFilterProxy")]),s._v("**的断点上：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811091833065-85d41e.png",alt:"image-20210811091833065"}})]),s._v(" "),t("p",[s._v("此时**"),t("em",[s._v("delegate")]),t("strong",[s._v("还是 null 的，接下来依次执行代码，可以看到")]),t("em",[s._v("delegate")]),t("strong",[s._v("最终被赋值一个")]),t("em",[s._v("FilterChainProxy")]),s._v("**的实例：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/f045b025-bd97-4222-8a02-51634be6745b-3fc9b3.png",alt:"img"}})]),s._v(" "),t("p",[s._v("接下来程序依次跳转到**"),t("em",[s._v("FilterChainProxy")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("和")]),t("em",[s._v("VirtualFilterChain")]),s._v("**的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/90d3e369-510f-45cb-982d-241d2eedb55c-c6ca6e.png",alt:"img"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/image-20210811092048784-60b58b.png",alt:"image-20210811092048784"}})]),s._v(" "),t("p",[s._v("接着程序跳转到**"),t("em",[s._v("AbstractAuthenticationProcessingFilter")]),t("strong",[s._v("（")]),t("em",[s._v("UsernamePasswordAuthenticationFilter")]),s._v("**的父类）的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("中，通过"),t("strong",[t("i",[s._v("requiresAuthentication()")])]),s._v("判定为 false（是否是 POST 请求）：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/2e5440bc-9488-4213-a030-0d25153bb2ea-4df00a.png",alt:"img"}})]),s._v(" "),t("p",[s._v("接着程序跳转到**"),t("em",[s._v("DefaultLoginPageGeneratingFilter")]),s._v("**的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("中，通过"),t("strong",[t("i",[s._v("isLoginUrlRequest()")])]),s._v("判定为 false（请求路径是否是"),t("strong",[t("i",[s._v("/login")])]),s._v("）：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/47a7bca4-d858-4cb1-b126-347805b74053-80ca77.png",alt:"img"}})]),s._v(" "),t("p",[s._v("接着程序跳转到**"),t("em",[s._v("AnonymousAuthenticationFilter")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("中，由于是首次请求，此时"),t("strong",[t("i",[s._v("SecurityContextHolder.getContext().getAuthentication()")])]),s._v("为 null，因此会生成一个")]),t("em",[s._v("AnonymousAuthenticationToken")]),s._v("**的实例：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6b1aded6-5229-47ba-b192-78a7c2622b8c-8ed4e0.png",alt:"img"}})]),s._v(" "),t("p",[s._v("接着程序跳转到**"),t("em",[s._v("ExceptionTranslationFilter")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("中，")]),t("em",[s._v("ExceptionTranslationFilter")]),t("strong",[s._v("负责处理")]),t("em",[s._v("FilterSecurityInterceptor")]),s._v("**抛出的异常，我们在 catch 代码块的首行打上断点：")]),s._v(" "),t("p",[t("strong",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/8efa0b1c-2b32-4d5b-9655-985374326e10-2c5fcb.png",alt:"img"}})])]),s._v(" "),t("p",[s._v("接着程序跳转到**"),t("em",[s._v("FilterSecurityInterceptor")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("中，依次执行代码后程序停留在其父类(")]),t("em",[s._v("AbstractSecurityInterceptor")]),s._v("**)的"),t("strong",[t("i",[s._v("attemptAuthorization()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/d6e99143-6207-43a5-8d04-f0c81baa11b4-c43162.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[t("em",[s._v("accessDecisionManager")]),t("strong",[s._v("是")]),t("em",[s._v("AccessDecisionManager")])]),s._v("(访问决策器)的实例，"),t("strong",[t("em",[s._v("AccessDecisionManager")]),t("strong",[s._v("主要有 3 个实现类：")]),t("em",[s._v("AffirmativeBased")])]),s._v("(一票通过)，"),t("strong",[s._v("ConsensusBased")]),s._v("(少数服从多数)、UnanimousBased(一票否决)，此时**"),t("em",[s._v("AccessDecisionManager")]),t("strong",[s._v("的的实现类是")]),t("em",[s._v("AffirmativeBased")]),t("strong",[s._v("，我们可以看到程序进入")]),t("em",[s._v("AffirmativeBased")]),s._v("**的"),t("strong",[t("i",[s._v("decide()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6724647c-34ee-4a57-8cfa-b46f57400d14-722c30.png",alt:"img"}})]),s._v(" "),t("p",[s._v("从上图可以看出，决策的关键在"),t("strong",[t("i",[s._v("voter.vote(authentication, object, configAttributes)")])]),s._v("这句代码上，通过跟踪调试，程序最终进入**"),t("em",[s._v("AuthenticationTrustResolverImpl")]),s._v("**的"),t("strong",[t("i",[s._v("isAnonymous()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/4beaa02f-a93d-4d95-9ad1-0d7213cb0e46-af72e9.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[t("i",[s._v("isAssignableFrom()")])]),s._v("判断前者是否是后者的父类，而**"),t("em",[s._v("anonymousClass")]),t("strong",[s._v("被固定为")]),t("em",[s._v("AnonymousAuthenticationToken.class")]),t("strong",[s._v("，参数")]),t("em",[s._v("authentication")]),t("strong",[s._v("由前面")]),t("em",[s._v("AnonymousAuthenticationFilter")]),t("strong",[s._v("可以知道是")]),t("em",[s._v("AnonymousAuthenticationToken")]),t("strong",[s._v("的实例，因此"),t("strong",[t("i",[s._v("isAnonymous()")])]),s._v("返回 true，")]),t("em",[s._v("FilterSecurityInterceptor")]),t("strong",[s._v("抛出")]),t("em",[s._v("AccessDeniedException")]),t("strong",[s._v("异常，程序返回")]),t("em",[s._v("ExceptionTranslationFilter")]),s._v("**的 catch 块中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/8e1ac9db-5987-484d-abf4-4c6535c60cc6-dd455f.png",alt:"img"}})]),s._v(" "),t("p",[s._v("接着程序会依次进入**"),t("em",[s._v("DelegatingAuthenticationEntryPoint")]),t("strong",[s._v("、")]),t("em",[s._v("LoginUrlAuthenticationEntryPoint")]),t("strong",[s._v("中，最后由")]),t("em",[s._v("LoginUrlAuthenticationEntryPoint")]),s._v("**的"),t("strong",[t("i",[s._v("commence()")])]),s._v("决定重定向到"),t("strong",[t("i",[s._v("/login")])]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1b03bdd4-6773-4b39-a664-fdf65d104403-fea7bd.png",alt:"img"}})]),s._v(" "),t("p",[s._v("后续对"),t("strong",[t("i",[s._v("/login")])]),s._v("的请求同样会经过之前的执行流程，在**"),t("em",[s._v("DefaultLoginPageGeneratingFilter")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("中，通过"),t("strong",[t("i",[s._v("isLoginUrlRequest()")])]),s._v("判定为 true（请求路径是否是"),t("strong",[t("i",[s._v("/login")])]),s._v("）,直接返回")]),t("em",[s._v("login.html")]),s._v("**，也就是我们开头看到的登录页面。")]),s._v(" "),t("p",[s._v("当我们输入用户名和密码，点击**"),t("em",[s._v("Sign in")]),t("strong",[s._v("，程序来到")]),t("em",[s._v("AbstractAuthenticationProcessingFilter")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("doFilter()")])]),s._v("中，通过"),t("strong",[t("i",[s._v("requiresAuthentication()")])]),s._v("判定为 true（是否是 POST 请求）,因此交给其子类")]),t("em",[s._v("UsernamePasswordAuthenticationFilter")]),t("strong",[s._v("进行处理，")]),t("em",[s._v("UsernamePasswordAuthenticationFilter")]),t("strong",[s._v("会将用户名和密码封装成一个")]),t("em",[s._v("UsernamePasswordAuthenticationToken")]),s._v("**的实例并进行校验，当校验通过后会将请求重定向到我们一开始请求的路径："),t("strong",[t("i",[s._v("/hello")])]),s._v("。")]),s._v(" "),t("p",[s._v("后续对"),t("strong",[t("i",[s._v("/hello")])]),s._v("的请求经过过滤器链时就可以一路开绿灯直到最终交由**"),t("em",[s._v("HelloController")]),s._v('**返回"Hello World"。')]),s._v(" "),t("h2",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),t("ol",[t("li",[t("p",[t("a",{attrs:{href:"https://docs.spring.io/spring-security/site/docs/current/reference/html5/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Spring Security Reference"),t("OutboundLink")],1)])]),s._v(" "),t("li",[t("p",[t("a",{attrs:{href:"https://mrbird.cc/Spring-Boot&Spring-Security.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Spring Boot 中开启 Spring Security"),t("OutboundLink")],1)])])]),s._v(" "),t("h1",{attrs:{id:"spring-security-自定义用户认证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#spring-security-自定义用户认证"}},[s._v("#")]),s._v(" Spring Security 自定义用户认证")]),s._v(" "),t("p",[s._v("在"),t("strong",[s._v("Spring Boot 中开启 Spring Security")]),s._v("一节中我们简单地搭建了一个 Spring Boot + Spring Security 的项目，其中登录页、用户名和密码都是由 Spring Security 自动生成的。Spring Security 支持我们自定义认证的过程，如使用自定义的登录页替换默认的登录页，用户信息的获取逻辑、登录成功或失败后的处理逻辑等。这里将在上一节的源码基础上进行改造。")]),s._v(" "),t("h2",{attrs:{id:"配置自定义登录页"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置自定义登录页"}},[s._v("#")]),s._v(" 配置自定义登录页")]),s._v(" "),t("p",[s._v("为了方便起见，我们直接在"),t("strong",[t("i",[s._v("src/main/resources/resources")])]),s._v("目录下创建一个"),t("strong",[t("i",[s._v("login.html")])]),s._v("（不需要 Controller 跳转）：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="UTF-8">\n    <title>登录</title>\n    <link rel="stylesheet" href="css/login.css" type="text/css">\n</head>\n<body>\n    <form class="login-page" action="/login" method="post">\n        <div class="form">\n            <h3>账户登录</h3>\n            <input type="text" placeholder="用户名" name="username" required="required" />\n            <input type="password" placeholder="密码" name="password" required="required" />\n            <button type="submit">登录</button>\n        </div>\n    </form>\n</body>\n</html>\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("要怎么做才能让 Spring Security 跳转到我们自己定义的登录页面呢？很简单，只需要在"),t("strong",[t("i",[s._v("BrowserSecurityConfig")])]),s._v("的"),t("strong",[t("i",[s._v("configure")])]),s._v("中添加一些配置：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('@Configuration\npublic class BrowserConfig extends WebSecurityConfigurerAdapter {\n    @Override\n    protected void configure(HttpSecurity http) throws Exception {\n        http.formLogin() // 表单登录\n                .loginPage("/login.html") // 自定义登录页\n                .loginProcessingUrl("/login") // 登录认证路径\n                .and()\n                .authorizeRequests() // 授权配置\n                .antMatchers("/login.html", "/css/</strong></i>", "/error").permitAll() // 无需认证\n                .anyRequest().authenticated() // 除antMatchers中配置路径外其他所有请求都需要认证\n                .and().csrf().disable();\n    }\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("上面代码中"),t("strong",[t("i",[s._v('.loginPage("/login.html")')])]),s._v("指定了跳转到登录页面的请求 URL，"),t("strong",[t("i",[s._v('.loginProcessingUrl("/login")')])]),s._v("对应登录页面 form 表单的"),t("strong",[t("i",[s._v('action="/login"')])]),s._v("，"),t("strong",[t("i",[s._v('.antMatchers("/login.html", "/css/", "/error").permitAll()')])]),s._v("表示跳转到登录页面的请求不被拦截。")]),s._v(" "),t("p",[s._v("这时候启动系统，访问"),t("strong",[t("i",[s._v("http://localhost:8080/hello")])]),s._v("，会看到页面已经被重定向到了"),t("strong",[t("i",[s._v("http://localhost:8080/login.html")])]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/d6bd19a2-08d3-4ba6-921c-5b5f57370a16-ed99eb.jpg",alt:"img"}})]),s._v(" "),t("h2",{attrs:{id:"配置用户信息的获取逻辑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置用户信息的获取逻辑"}},[s._v("#")]),s._v(" 配置用户信息的获取逻辑")]),s._v(" "),t("p",[s._v("Spring Security 默认会为我们生成一个用户名为 user，密码随机的用户实例，当然我们也可以定义自己用户信息的获取逻辑，只需要实现 Spring Security 提供的**"),t("em",[s._v("UserDetailService")]),t("strong",[s._v("接口即可，该接口只有一个抽象方法")]),t("em",[s._v("loadUserByUsername")]),s._v("**，具体实现如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('@Service\npublic class UserDetailService implements UserDetailsService {\n    @Autowired\n    private PasswordEncoder passwordEncoder;\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        return new User(username, passwordEncoder.encode("123456"), AuthorityUtils.createAuthorityList("admin"));\n    }\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("通过以上配置，我们定义了一个用户名随机，密码统一为 123456 的用户信息的获取逻辑。这样，当我们启动项目，访问"),t("strong",[t("i",[s._v("http://localhost:8080/login")])]),s._v("，只需要输入任意用户名以及 123456 作为密码即可登录系统。")]),s._v(" "),t("h2",{attrs:{id:"源码解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#源码解析"}},[s._v("#")]),s._v(" 源码解析")]),s._v(" "),t("h3",{attrs:{id:"browserconfig-配置解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#browserconfig-配置解析"}},[s._v("#")]),s._v(" BrowserConfig 配置解析")]),s._v(" "),t("p",[s._v("我们首先来梳理下"),t("strong",[t("i",[s._v("BrowserConfig")])]),s._v("中的配置是如何被 Spring Security 所加载的。")]),s._v(" "),t("p",[s._v("首先找到调用"),t("strong",[t("i",[s._v("BrowserConfig")])]),s._v("的"),t("strong",[t("i",[s._v("configure()")])]),s._v("的地方，在其父类"),t("strong",[t("i",[s._v("WebSecurityConfigurerAdapter")])]),s._v("的"),t("strong",[t("i",[s._v("getHttp()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/12629a18-56ef-4286-9ab9-c124dc3d6791-d5ce43.png",alt:"img"}})]),s._v(" "),t("p",[s._v("往上一步找到调用"),t("strong",[t("i",[s._v("getHttp()")])]),s._v("的地方，在同个类的"),t("strong",[t("i",[s._v("init()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/2b54af34-7d68-4f40-8726-d02d18e03dea-89264f.png",alt:"img"}})]),s._v(" "),t("p",[s._v("往上一步找到调用"),t("strong",[t("i",[s._v("init()")])]),s._v("的地方，在"),t("strong",[t("i",[s._v("AbstractConfiguredSecurityBuilder")])]),s._v("的"),t("strong",[t("i",[s._v("init()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6e009bf1-aba3-4b89-8e86-d3d110e0f4a7-0b5c99.png",alt:"img"}})]),s._v(" "),t("p",[s._v("在"),t("strong",[t("i",[s._v("init()")])]),s._v("被调用时，它首先会遍历"),t("strong",[t("i",[s._v("getConfigurers()")])]),s._v("返回的集合中的元素，调用其"),t("strong",[t("i",[s._v("init()")])]),s._v("，点击"),t("strong",[t("i",[s._v("getConfigurers()")])]),s._v("查看，发现其读取的是"),t("strong",[t("i",[s._v("configurers")])]),s._v("属性的值，那么"),t("strong",[t("i",[s._v("configurers")])]),s._v("是什么时候被赋值的呢？我们在同个类的"),t("strong",[t("i",[s._v("add()")])]),s._v("中找到"),t("strong",[t("i",[s._v("configurers")])]),s._v("被赋值的代码：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ed65fd2a-8a9f-4808-bc16-36128b4af47a-f7e589.png",alt:"img"}})]),s._v(" "),t("p",[s._v("往上一步找到调用"),t("strong",[t("i",[s._v("add()")])]),s._v("的地方，在同个类的"),t("strong",[t("i",[s._v("apply()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1e929fec-d1ab-44b5-89bc-6e5ebcda1daf-783836.png",alt:"img"}})]),s._v(" "),t("p",[s._v("往上一步找到调用"),t("strong",[t("i",[s._v("apply()")])]),s._v("的地方，在"),t("strong",[t("i",[s._v("WebSecurityConfiguration")])]),s._v("的"),t("strong",[t("i",[s._v("setFilterChainProxySecurityConfigurer()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1840f96a-6a31-4fce-8a98-02fa7fc60fbf-04df5b.png",alt:"img"}})]),s._v(" "),t("p",[s._v("我们可以看到，在"),t("strong",[t("i",[s._v("setFilterChainProxySecurityConfigurer()")])]),s._v("中，首先会实例化一个"),t("strong",[t("i",[s._v("WebSecurity")])]),s._v("（"),t("strong",[t("i",[s._v("AbstractConfiguredSecurityBuilder")])]),s._v("的实现类）的实例，遍历参数"),t("strong",[t("i",[s._v("webSecurityConfigurers")])]),s._v("，将存储在其中的元素作为参数传递给"),t("strong",[t("i",[s._v("WebSecurity")])]),s._v("的"),t("strong",[t("i",[s._v("apply()")])]),s._v("，那么"),t("strong",[t("i",[s._v("webSecurityConfigurers")])]),s._v("是什么时候被赋值的呢？我们根据"),t("strong",[t("i",[s._v("@Value")])]),s._v("中的信息找到"),t("strong",[t("i",[s._v("webSecurityConfigurers")])]),s._v("被赋值的地方，在"),t("strong",[t("i",[s._v("AutowiredWebSecurityConfigurersIgnoreParents")])]),s._v("的"),t("strong",[t("i",[s._v("getWebSecurityConfigurers()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/eb7a5916-4049-4682-9a11-10f1f1f94c74-c2bc42.png",alt:"img"}})]),s._v(" "),t("p",[s._v("我们重点看第二句代码，可以看到这里会提取存储在 bean 工厂中类型为"),t("strong",[t("i",[s._v("WebSecurityConfigurer.class")])]),s._v("的 bean，而"),t("strong",[t("i",[s._v("BrowserConfig")])]),s._v("正是"),t("strong",[t("i",[s._v("WebSecurityConfigurerAdapter")])]),s._v("的实现类。")]),s._v(" "),t("p",[s._v("解决完"),t("strong",[t("i",[s._v("configurers")])]),s._v("的赋值问题，我们回到"),t("strong",[t("i",[s._v("AbstractConfiguredSecurityBuilder")])]),s._v("的"),t("strong",[t("i",[s._v("init()")])]),s._v("处，找到调用该方法的地方，在同个类的"),t("strong",[t("i",[s._v("doBuild()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/522574e3-bacc-4794-a17e-492bc2b4457d-b07011.png",alt:"img"}})]),s._v(" "),t("p",[s._v("往上一步找到调用"),t("strong",[t("i",[s._v("doBuild()")])]),s._v("的地方，在"),t("strong",[t("i",[s._v("AbstractSecurityBuilder")])]),s._v("的"),t("strong",[t("i",[s._v("build()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/fb22f2ca-3d9a-420f-b77a-f9c0f737d9ad-60dcd2.png",alt:"img"}})]),s._v(" "),t("p",[s._v("往上一步找到调用"),t("strong",[t("i",[s._v("doBuild()")])]),s._v("的地方，在"),t("strong",[t("i",[s._v("WebSecurityConfiguration")])]),s._v("的"),t("strong",[t("i",[s._v("springSecurityFilterChain()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/a5c61feb-ca72-4768-94bd-1b0a8cf8af70-fbe06b.png",alt:"img"}})]),s._v(" "),t("p",[s._v("至此，我们分析完了"),t("strong",[t("i",[s._v("BrowserConfig")])]),s._v("被 Spring Security 加载的过程。现在我们再来看看当我们自定义的配置被加载完后，"),t("strong",[t("i",[s._v("http")])]),s._v("各属性的变化，在"),t("strong",[t("i",[s._v("BrowserConfig")])]),s._v("的"),t("strong",[t("i",[s._v("configure()")])]),s._v("末尾打上断点，当程序走到断点处时，查看"),t("strong",[t("i",[s._v("http")])]),s._v("属性：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6c72c09b-742c-4415-851a-8ca5292a4969-f39334.png",alt:"img"}})]),s._v(" "),t("p",[s._v("我们配置的"),t("strong",[t("i",[s._v('.loginPage("/login.html")')])]),s._v("和"),t("strong",[t("i",[s._v('.loginProcessingUrl("/login")')])]),s._v("在"),t("strong",[t("i",[s._v("FormLoginConfigurer")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/51ba02f0-bae6-4c08-9adf-7ee0f12b05d3-041ec9.png",alt:"img"}})]),s._v(" "),t("p",[s._v("配置的"),t("strong",[t("i",[s._v('.antMatchers("/login.html", "/css/", "/error").permitAll()')])]),s._v("在"),t("strong",[t("i",[s._v("ExpressionUrlAuthorizationConfigurer")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/52390725-d87d-42b1-9071-ea21e445e1e6-c76af1.png",alt:"img"}})]),s._v(" "),t("p",[s._v("这样，当我们访问除"),t("strong",[t("i",[s._v('"/login.html", "/css/", "/error"')])]),s._v("以外的路径时，在"),t("strong",[t("i",[s._v("AbstractSecurityInterceptor")])]),s._v("（"),t("strong",[t("i",[s._v("FilterSecurityInterceptor")])]),s._v("的父类）的"),t("strong",[t("i",[s._v("attemptAuthorization()")])]),s._v("中会抛出"),t("strong",[t("i",[s._v("AccessDeniedException")])]),s._v("异常（最终由"),t("strong",[t("i",[s._v("AuthenticationTrustResolverImpl")])]),s._v("的"),t("strong",[s._v("isAnonymous()")]),s._v("进行判断）")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/558b8b1c-be32-44c4-8d8f-5f0d231741f8-e4e13c.png",alt:"img"}})]),s._v(" "),t("p",[s._v("当我们访问"),t("strong",[t("i",[s._v('"/login.html", "/css/", "/error"')])]),s._v("这几个路径时，在"),t("strong",[t("i",[s._v("AbstractSecurityInterceptor")])]),s._v("（"),t("strong",[t("i",[s._v("FilterSecurityInterceptor")])]),s._v("的父类）的"),t("strong",[t("i",[s._v("attemptAuthorization()")])]),s._v("中正常执行（最终由"),t("strong",[t("i",[s._v("SecurityExpressionRoot")])]),s._v("的"),t("strong",[t("i",[s._v("permitAll()")])]),s._v("进行判断）")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/4612c27e-dd9f-4e60-92dc-fc9858496ec5-cb532b.png",alt:"img"}})]),s._v(" "),t("h3",{attrs:{id:"login-html-路径解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#login-html-路径解析"}},[s._v("#")]),s._v(" login.html 路径解析")]),s._v(" "),t("p",[s._v("当我们请求的资源需要经过认证时，Spring Security 会将请求重定向到我们自定义的登录页，那么 Spring 又是如何找到我们自定义的登录页的呢？下面就让我们来解析一下：")]),s._v(" "),t("p",[s._v("我们首先来到"),t("strong",[t("i",[s._v("DispatcherServlet")])]),s._v("中，"),t("strong",[t("i",[s._v("DispatcherServlet")])]),s._v("是 Spring Web 处理请求的入口。当 Spring Web 项目启动后，第一次接收到请求时，会调用其"),t("strong",[t("i",[s._v("initStrategies()")])]),s._v("进行初始化：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/964ec4a4-6039-4205-8a87-ea2febcc00b6-3d24d5.png",alt:"img"}})]),s._v(" "),t("p",[s._v("我们重点关注"),t("strong",[t("i",[s._v("initHandlerMappings(context);")])]),s._v("这句，"),t("strong",[t("i",[s._v("initHandlerMappings()")])]),s._v("用于初始化处理器映射器（处理器映射器可以根据请求找到对应的资源），我们来到"),t("strong",[t("i",[s._v("initHandlerMappings()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/0a97b011-34ed-4d57-945e-95c8e6bafc8e-b26642.png",alt:"img"}})]),s._v(" "),t("p",[s._v("可以看到，当程序走到"),t("strong",[t("i",[s._v("initHandlerMappings()")])]),s._v("中时，会从 bean 工厂中找出"),t("strong",[t("i",[s._v("HandlerMapping.class")])]),s._v("类型的 bean，将其存储到"),t("strong",[t("i",[s._v("handlerMappings")])]),s._v("属性中。这里看到一共找到 5 个，分别是："),t("strong",[t("i",[s._v("requestMappingHandlerMapping")])]),s._v("（将请求与标注了"),t("strong",[t("i",[s._v("@RequestMapping")])]),s._v("的方法进行关联）、"),t("strong",[t("i",[s._v("weclomePageHandlerMapping")])]),s._v("（将请求与主页进行关联）、"),t("strong",[t("i",[s._v("beanNameHandlerMapping")])]),s._v("（将请求与同名的 bean 进行关联）、"),t("strong",[t("i",[s._v("routerFunctionMapping")])]),s._v("（将请求与"),t("strong",[t("i",[s._v("RouterFunction")])]),s._v("进行关联）、"),t("strong",[t("i",[s._v("resourceHandlerMapping")])]),s._v("（将请求与静态资源进行关联），这 5 个 bean 是在"),t("strong",[t("i",[s._v("WebMvcAutoConfiguration$EnableWebMvcConfiguration")])]),s._v("中配置的：")]),s._v(" "),t("p",[t("strong",[t("i",[s._v("requestMappingHandlerMapping:")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/cd7aee86-66f8-4197-99d1-1c9275e33bee-fe5fff.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[t("i",[s._v("weclomePageHandlerMapping:")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ef28372b-de89-46ff-8679-8b8feca04a7a-d48d4f.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[t("i",[s._v("beanNameHandlerMapping")])]),s._v("、"),t("strong",[t("i",[s._v("routerFunctionMapping")])]),s._v("、"),t("strong",[t("i",[s._v("resourceHandlerMapping")])]),s._v("在"),t("strong",[t("i",[s._v("EnableWebMvcConfiguration")])]),s._v("的父类（"),t("strong",[t("i",[s._v("WebMvcConfigurationSupport")])]),s._v("）中配置：")]),s._v(" "),t("p",[t("strong",[t("i",[s._v("beanNameHandlerMapping:")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/8d05ac54-f034-47d4-b750-67b2e3b3cd14-79ea81.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[t("i",[s._v("routerFunctionMapping:")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/481b88aa-028d-4392-8c0a-365f1d0e2ae9-10387b.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[t("i",[s._v("resourceHandlerMapping:")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/fcdab503-2735-46bd-a5b6-226dc348e78c-97f6ca.png",alt:"img"}})]),s._v(" "),t("p",[s._v("我们将目光锁定在"),t("strong",[t("i",[s._v("resourceHandlerMapping")])]),s._v("上，当"),t("strong",[t("i",[s._v("resourceHandlerMapping")])]),s._v("被初始化时，会调用"),t("strong",[t("i",[s._v("addResourceHandlers()")])]),s._v("为"),t("strong",[t("i",[s._v("registry")])]),s._v("添加资源处理器，我们找到实际被调用的"),t("strong",[t("i",[s._v("addResourceHandlers()")])]),s._v("，在"),t("strong",[t("i",[s._v("DelegatingWebMvcConfiguration")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6eca7b58-80f9-4e98-8483-62b4ef751854-7a802c.png",alt:"img"}})]),s._v(" "),t("p",[s._v("可以看到这里实际调用的是"),t("strong",[t("i",[s._v("configurers")])]),s._v("属性的"),t("strong",[t("i",[s._v("addResourceHandlers()")])]),s._v("，而"),t("strong",[t("i",[s._v("configurers")])]),s._v("是一个 final 类型的成员变量，其值是"),t("strong",[t("i",[s._v("WebMvcConfigurerComposite")])]),s._v("的实例，我们来到"),t("strong",[t("i",[s._v("WebMvcConfigurerComposite")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/c365e5ab-a7a3-4ebf-8a25-09cd2e049f22-1393ac.png",alt:"img"}})]),s._v(" "),t("p",[s._v("可以看到这里实际调用的是"),t("strong",[t("i",[s._v("delegates")])]),s._v("属性的"),t("strong",[t("i",[s._v("addResourceHandlers()")])]),s._v("，"),t("strong",[t("i",[s._v("delegates")])]),s._v("是一个 final 类型的集合，集合的元素由"),t("strong",[t("i",[s._v("addWebMvcConfigurers()")])]),s._v("负责添加：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/895afead-ea6b-4ac6-8138-fbe0a223daf9-2b3a9d.png",alt:"img"}})]),s._v(" "),t("p",[s._v("我们找到调用"),t("strong",[t("i",[s._v("addWebMvcConfigurers()")])]),s._v("的地方，在"),t("strong",[t("i",[s._v("DelegatingWebMvcConfiguration")])]),s._v("的"),t("strong",[t("i",[s._v("setConfigurers()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/a20e06a4-5a43-4edf-bea1-53fc9bc929e9-9eed17.png",alt:"img"}})]),s._v(" "),t("p",[s._v("可以看到当"),t("strong",[t("i",[s._v("setConfigurers()")])]),s._v("被初始化时，Spring 会往参数"),t("strong",[t("i",[s._v("configurers")])]),s._v("中传入两个值，我们关注第一个值，是一个"),t("strong",[t("i",[s._v("WebMvcAutoConfiguration"),t("span",{staticClass:"katex"},[t("span",{staticClass:"katex-mathml"},[t("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[t("semantics",[t("mrow",[t("mi",[s._v("W")]),t("mi",[s._v("e")]),t("mi",[s._v("b")]),t("mi",[s._v("M")]),t("mi",[s._v("v")]),t("mi",[s._v("c")]),t("mi",[s._v("A")]),t("mi",[s._v("u")]),t("mi",[s._v("t")]),t("mi",[s._v("o")]),t("mi",[s._v("C")]),t("mi",[s._v("o")]),t("mi",[s._v("n")]),t("mi",[s._v("f")]),t("mi",[s._v("i")]),t("mi",[s._v("g")]),t("mi",[s._v("u")]),t("mi",[s._v("r")]),t("mi",[s._v("a")]),t("mi",[s._v("t")]),t("mi",[s._v("i")]),t("mi",[s._v("o")]),t("mi",[s._v("n")]),t("mi",[s._v("A")]),t("mi",[s._v("d")]),t("mi",[s._v("a")]),t("mi",[s._v("p")]),t("mi",[s._v("t")]),t("mi",[s._v("e")]),t("mi",[s._v("r")]),t("mo",[s._v("<")]),t("mi",{attrs:{mathvariant:"normal"}},[s._v("/")]),t("mi",[s._v("s")]),t("mi",[s._v("t")]),t("mi",[s._v("r")]),t("mi",[s._v("o")]),t("mi",[s._v("n")]),t("mi",[s._v("g")]),t("mo",[s._v(">")]),t("mo",[s._v("<")]),t("mi",{attrs:{mathvariant:"normal"}},[s._v("/")]),t("mi",[s._v("i")]),t("mo",[s._v(">")]),t("mtext",[s._v("的实例，注意它的属性")]),t("mo",[s._v("<")]),t("mi",[s._v("s")]),t("mi",[s._v("t")]),t("mi",[s._v("r")]),t("mi",[s._v("o")]),t("mi",[s._v("n")]),t("mi",[s._v("g")]),t("mo",[s._v(">")]),t("mo",[s._v("<")]),t("mi",[s._v("i")]),t("mo",[s._v(">")]),t("mi",[s._v("r")]),t("mi",[s._v("e")]),t("mi",[s._v("s")]),t("mi",[s._v("o")]),t("mi",[s._v("u")]),t("mi",[s._v("r")]),t("mi",[s._v("c")]),t("mi",[s._v("e")]),t("mi",[s._v("P")]),t("mi",[s._v("r")]),t("mi",[s._v("o")]),t("mi",[s._v("p")]),t("mi",[s._v("e")]),t("mi",[s._v("r")]),t("mi",[s._v("t")]),t("mi",[s._v("i")]),t("mi",[s._v("e")]),t("mi",[s._v("s")]),t("mo",[s._v("<")]),t("mi",{attrs:{mathvariant:"normal"}},[s._v("/")]),t("mi",[s._v("s")]),t("mi",[s._v("t")]),t("mi",[s._v("r")]),t("mi",[s._v("o")]),t("mi",[s._v("n")]),t("mi",[s._v("g")]),t("mo",[s._v(">")]),t("mo",[s._v("<")]),t("mi",{attrs:{mathvariant:"normal"}},[s._v("/")]),t("mi",[s._v("i")]),t("mo",[s._v(">")]),t("mtext",[s._v("，是一个")]),t("mo",[s._v("<")]),t("mi",[s._v("s")]),t("mi",[s._v("t")]),t("mi",[s._v("r")]),t("mi",[s._v("o")]),t("mi",[s._v("n")]),t("mi",[s._v("g")]),t("mo",[s._v(">")]),t("mo",[s._v("<")]),t("mi",[s._v("i")]),t("mo",[s._v(">")]),t("mi",[s._v("W")]),t("mi",[s._v("e")]),t("mi",[s._v("b")]),t("mi",[s._v("P")]),t("mi",[s._v("r")]),t("mi",[s._v("o")]),t("mi",[s._v("p")]),t("mi",[s._v("e")]),t("mi",[s._v("r")]),t("mi",[s._v("t")]),t("mi",[s._v("i")]),t("mi",[s._v("e")]),t("mi",[s._v("s")])],1),t("annotation",{attrs:{encoding:"application/x-tex"}},[s._v("WebMvcAutoConfigurationAdapter</strong></i>的实例，注意它的属性<strong><i>resourceProperties</strong></i>，是一个<strong><i>WebProperties")])],1)],1)],1),t("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"0.8889em","vertical-align":"-0.1944em"}}),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.13889em"}},[s._v("W")]),t("span",{staticClass:"mord mathnormal"},[s._v("e")]),t("span",{staticClass:"mord mathnormal"},[s._v("b")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.10903em"}},[s._v("M")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.03588em"}},[s._v("v")]),t("span",{staticClass:"mord mathnormal"},[s._v("c")]),t("span",{staticClass:"mord mathnormal"},[s._v("A")]),t("span",{staticClass:"mord mathnormal"},[s._v("u")]),t("span",{staticClass:"mord mathnormal"},[s._v("t")]),t("span",{staticClass:"mord mathnormal"},[s._v("o")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[s._v("C")]),t("span",{staticClass:"mord mathnormal"},[s._v("o")]),t("span",{staticClass:"mord mathnormal"},[s._v("n")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.10764em"}},[s._v("f")]),t("span",{staticClass:"mord mathnormal"},[s._v("i")]),t("span",{staticClass:"mord mathnormal"},[s._v("gu")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.02778em"}},[s._v("r")]),t("span",{staticClass:"mord mathnormal"},[s._v("a")]),t("span",{staticClass:"mord mathnormal"},[s._v("t")]),t("span",{staticClass:"mord mathnormal"},[s._v("i")]),t("span",{staticClass:"mord mathnormal"},[s._v("o")]),t("span",{staticClass:"mord mathnormal"},[s._v("n")]),t("span",{staticClass:"mord mathnormal"},[s._v("A")]),t("span",{staticClass:"mord mathnormal"},[s._v("d")]),t("span",{staticClass:"mord mathnormal"},[s._v("a")]),t("span",{staticClass:"mord mathnormal"},[s._v("pt")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.02778em"}},[s._v("er")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v("<")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),t("span",{staticClass:"mord"},[s._v("/")]),t("span",{staticClass:"mord mathnormal"},[s._v("s")]),t("span",{staticClass:"mord mathnormal"},[s._v("t")]),t("span",{staticClass:"mord mathnormal"},[s._v("ro")]),t("span",{staticClass:"mord mathnormal"},[s._v("n")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.03588em"}},[s._v("g")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v("><")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),t("span",{staticClass:"mord"},[s._v("/")]),t("span",{staticClass:"mord mathnormal"},[s._v("i")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v(">")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"0.7224em","vertical-align":"-0.0391em"}}),t("span",{staticClass:"mord cjk_fallback"},[s._v("的实例，注意它的属性")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v("<")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"0.8095em","vertical-align":"-0.1944em"}}),t("span",{staticClass:"mord mathnormal"},[s._v("s")]),t("span",{staticClass:"mord mathnormal"},[s._v("t")]),t("span",{staticClass:"mord mathnormal"},[s._v("ro")]),t("span",{staticClass:"mord mathnormal"},[s._v("n")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.03588em"}},[s._v("g")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v("><")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"0.6986em","vertical-align":"-0.0391em"}}),t("span",{staticClass:"mord mathnormal"},[s._v("i")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v(">")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"0.8778em","vertical-align":"-0.1944em"}}),t("span",{staticClass:"mord mathnormal"},[s._v("reso")]),t("span",{staticClass:"mord mathnormal"},[s._v("u")]),t("span",{staticClass:"mord mathnormal"},[s._v("rce")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.13889em"}},[s._v("P")]),t("span",{staticClass:"mord mathnormal"},[s._v("ro")]),t("span",{staticClass:"mord mathnormal"},[s._v("p")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.02778em"}},[s._v("er")]),t("span",{staticClass:"mord mathnormal"},[s._v("t")]),t("span",{staticClass:"mord mathnormal"},[s._v("i")]),t("span",{staticClass:"mord mathnormal"},[s._v("es")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v("<")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),t("span",{staticClass:"mord"},[s._v("/")]),t("span",{staticClass:"mord mathnormal"},[s._v("s")]),t("span",{staticClass:"mord mathnormal"},[s._v("t")]),t("span",{staticClass:"mord mathnormal"},[s._v("ro")]),t("span",{staticClass:"mord mathnormal"},[s._v("n")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.03588em"}},[s._v("g")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v("><")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),t("span",{staticClass:"mord"},[s._v("/")]),t("span",{staticClass:"mord mathnormal"},[s._v("i")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v(">")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"0.7224em","vertical-align":"-0.0391em"}}),t("span",{staticClass:"mord cjk_fallback"},[s._v("，是一个")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v("<")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"0.8095em","vertical-align":"-0.1944em"}}),t("span",{staticClass:"mord mathnormal"},[s._v("s")]),t("span",{staticClass:"mord mathnormal"},[s._v("t")]),t("span",{staticClass:"mord mathnormal"},[s._v("ro")]),t("span",{staticClass:"mord mathnormal"},[s._v("n")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.03588em"}},[s._v("g")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v("><")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"0.6986em","vertical-align":"-0.0391em"}}),t("span",{staticClass:"mord mathnormal"},[s._v("i")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}}),t("span",{staticClass:"mrel"},[s._v(">")]),t("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2778em"}})]),t("span",{staticClass:"base"},[t("span",{staticClass:"strut",staticStyle:{height:"0.8889em","vertical-align":"-0.1944em"}}),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.13889em"}},[s._v("W")]),t("span",{staticClass:"mord mathnormal"},[s._v("e")]),t("span",{staticClass:"mord mathnormal"},[s._v("b")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.13889em"}},[s._v("P")]),t("span",{staticClass:"mord mathnormal"},[s._v("ro")]),t("span",{staticClass:"mord mathnormal"},[s._v("p")]),t("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.02778em"}},[s._v("er")]),t("span",{staticClass:"mord mathnormal"},[s._v("t")]),t("span",{staticClass:"mord mathnormal"},[s._v("i")]),t("span",{staticClass:"mord mathnormal"},[s._v("es")])])])]),s._v("Resources")])]),s._v("的实例，默认情况下，在实例化"),t("strong",[t("i",[s._v("WebMvcAutoConfigurationAdapter")])]),s._v("时，由传入参数"),t("strong",[t("i",[s._v("webProperties")])]),s._v("进行赋值："),t("strong",[t("i",[s._v("webProperties.getResources()")])]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/97b6f22c-414d-4a16-aa8e-c3deece2f7cd-e7ca3d.png",alt:"img"}})]),s._v(" "),t("p",[s._v("我们进入参数"),t("strong",[t("i",[s._v("webProperties")])]),s._v("的类中，可以看到"),t("strong",[t("i",[s._v("getResources()")])]),s._v("是直接实例化了一个"),t("strong",[t("i",[s._v("Resources")])]),s._v("，其属性"),t("strong",[t("i",[s._v("staticLocations")])]),s._v("是一个含有 4 个值的 final 类型的字符串数组，这 4 个值正是 Spring 寻找静态文件的地方：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/4d84fe43-2646-4a6f-a580-f39f6416d02d-db197a.png",alt:"img"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/25899949-dac3-4873-a2af-7abfe0e97615-cc8d89.png",alt:"img"}})]),s._v(" "),t("p",[s._v("我们回到"),t("strong",[t("i",[s._v("WebMvcAutoConfiguration")])]),s._v("的"),t("strong",[t("i",[s._v("addResourceHandlers()")])]),s._v("中："),t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/003ff2fa-022e-47cb-8aa9-343ed7c40c4a-40568a.png",alt:"img"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ccd16b38-d724-4c03-949e-3b6ba03268a9-e6d109.png",alt:"img"}})]),s._v(" "),t("p",[s._v("在"),t("strong",[t("i",[s._v("addResourceHandlers()")])]),s._v("中，会为"),t("strong",[t("i",[s._v("registry")])]),s._v("添加两个资源处理器，当请求路径是“/webjars/”时，会在”classpath:/META-INF/resources/webjars/“路径下寻找对应的资源，当请求路径是“/**”时，会在”classpath:/META-INF/resources/“、”classpath:/resources/“、”classpath:/static/“、”classpath:/public/“路径下寻找对应的资源。")]),s._v(" "),t("p",[s._v("现在我们通过访问"),t("strong",[t("i",[s._v("http://localhost:8080/login.html")])]),s._v("来验证这个过程。")]),s._v(" "),t("p",[s._v("请求首先来到"),t("strong",[t("i",[s._v("DispatcherServlet")])]),s._v("的"),t("strong",[t("i",[s._v("doDispatch()")])]),s._v("中，由于是对静态资源的请求，当程序走到"),t("strong",[t("i",[s._v("mappedHandler = getHandler(processedRequest);")])]),s._v("时，通过"),t("strong",[t("i",[s._v("getHandler()")])]),s._v("返回"),t("strong",[t("i",[s._v("SimpleUrlHandlerMapping")])]),s._v("（即"),t("strong",[t("i",[s._v("resourceHandlerMapping")])]),s._v("的类型）的"),t("strong",[t("i",[s._v("HandlerExecutionChain")])]),s._v("：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/4c9c302d-2ce0-4b5b-beb6-c76d2e94038f-6114ba.png",alt:"img"}})]),s._v(" "),t("p",[s._v("然后由实际的处理器进行处理：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1590bae4-2e3a-4f97-b02d-d918c49cac22-3f264e.png",alt:"img"}})]),s._v(" "),t("p",[s._v("程序一路调试，来到"),t("strong",[t("i",[s._v("ResourceHttpRequestHandler")])]),s._v("的"),t("strong",[t("i",[s._v("handleRequest()")])]),s._v("中，通过调用"),t("strong",[t("i",[s._v("Resource resource = getResource(request);")])]),s._v("找到请求对应的资源：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/0879e131-da5f-491e-a153-42770ce8b975-2e188c.png",alt:"img"}})]),s._v(" "),t("p",[s._v("而在"),t("strong",[t("i",[s._v("getResource()")])]),s._v("中，实际是将请求路径（即"),t("strong",[t("i",[s._v("login.html")])]),s._v("）与前面配置的路径进行拼接（组合成"),t("strong",[t("i",[s._v("/resources/login.html")])]),s._v("这样的路径），再通过类加载器来寻找资源。")]),s._v(" "),t("p",[s._v("后面源码深入过深，就不一一展开了，只截取其中比较重要的几段代码：")]),s._v(" "),t("p",[t("strong",[t("i",[s._v("PathResourceResolver")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/6c58e27d-dd29-48fc-b597-8067e1c97786-3dba54.png",alt:"img"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/c7ef78df-c2ab-4f89-b5ad-45561a91ffcc-3bfb65.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[t("i",[s._v("ClassPathResource")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/42c5125e-0dc2-4c0c-9434-af4a9efd2d5d-ef27fc.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[t("i",[s._v("ClassLoader")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/7842f83d-5417-4cb2-bb30-d70f98c3053f-e44fa7.png",alt:"img"}})]),s._v(" "),t("p",[t("strong",[t("i",[s._v("URLClassLoader")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/870891e9-f8ea-4097-98c9-829b1cdcf145-4db6b8.png",alt:"img"}})]),s._v(" "),t("p",[s._v("最终，类加载器会在如上两个路径下找到登录页并返回。")]),s._v(" "),t("h3",{attrs:{id:"userdetailservice-配置解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#userdetailservice-配置解析"}},[s._v("#")]),s._v(" UserDetailService 配置解析")]),s._v(" "),t("p",[s._v("我们定义的用户信息的获取逻辑是如何被 Spring Security 应用的呢？让我们通过阅读源码来了解一下。")]),s._v(" "),t("p",[s._v("还记得前面我们讲**"),t("em",[s._v("BrowserConfig 配置")]),t("strong",[s._v("被加载的过程吗？")]),t("em",[s._v("UserDetailService")]),t("strong",[s._v("也是在这个过程中被一起加载完成的，回到")]),s._v("BrowserConfig 配置解析**的第一幅图中，如下：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/68490740-e03c-4353-b5fc-ac99c0cf0435-066f58.png",alt:"img"}})]),s._v(" "),t("p",[s._v("在断点处位置，"),t("strong",[t("i",[s._v("authenticationManager()")])]),s._v("会返回一个**"),t("em",[s._v("AuthenticationManager")]),s._v("**实例，我们进入"),t("strong",[t("i",[s._v("authenticationManager()")])]),s._v("中:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/e7a1a684-64db-41d0-a5c0-d9a841d86cc1-26b91c.png",alt:"img"}})]),s._v(" "),t("p",[s._v("在"),t("strong",[t("i",[s._v("authenticationManager()")])]),s._v("中，**"),t("em",[s._v("AuthenticationManager")]),t("strong",[s._v("转由")]),t("em",[s._v("AuthenticationConfiguration")]),s._v("**中获取，我们进入"),t("strong",[t("i",[s._v("getAuthenticationManager()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/d9ae84ae-d60c-4d9c-a7fd-cddeb1142f95-736c32.png",alt:"img"}})]),s._v(" "),t("p",[s._v("程序来到**"),t("em",[s._v("AuthenticationConfiguration")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("getAuthenticationManager()")])]),s._v("中，")]),t("em",[s._v("AuthenticationManager")]),t("strong",[s._v("转由")]),t("em",[s._v("AuthenticationManagerBuilder")]),s._v("**中获取，我们进入"),t("strong",[t("i",[s._v("build()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/19f71152-f456-4db7-a1d5-f79aaa37253b-7df7ee.png",alt:"img"}})]),s._v(" "),t("p",[s._v("程序来到**"),t("em",[s._v("AbstractConfiguredSecurityBuilder")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("doBuild()")])]),s._v("中，这里在构建")]),t("em",[s._v("AuthenticationManager")]),t("strong",[s._v("实例时，需要初始化 3 个配置类，我们重点关注第 3 个配置类：")]),t("em",[s._v("org.springframework.security.config.annotation.authentication.configuration.InitializeUserDetailsBeanManagerConfigurer")]),t("strong",[s._v("，这个配置类是在")]),t("em",[s._v("AuthenticationConfiguration")]),s._v("**中引入的：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/9f06c823-645d-413b-8bb6-1d81b8f329ea-9c9382.png",alt:"img"}})]),s._v(" "),t("p",[s._v("我们来到**"),t("em",[s._v("InitializeUserDetailsBeanManagerConfigurer")]),s._v("**的"),t("strong",[t("i",[s._v("init()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/cd7d6cb9-c6e7-4570-aab8-309adcb15e16-8f321c.png",alt:"img"}})]),s._v(" "),t("p",[s._v("这里会新建一个**"),t("em",[s._v("InitializeUserDetailsManagerConfigurer")]),t("strong",[s._v("实例添加到")]),t("em",[s._v("AuthenticationManagerBuilder")]),s._v("**中。我们回到"),t("strong",[t("i",[s._v("doBuild()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/3ea76980-417d-4c0c-9330-e0bb241c6a47-10e5ba.png",alt:"img"}})]),s._v(" "),t("p",[s._v("可以看到配置类变成了 5 个，其中就有刚刚新建的**"),t("em",[s._v("InitializeUserDetailsManagerConfigurer")]),t("strong",[s._v("，程序接下来会调用各个配置类的"),t("strong",[t("i",[s._v("configure()")])]),s._v("进行配置，我们来到")]),t("em",[s._v("InitializeUserDetailsManagerConfigurer")]),s._v("**的"),t("strong",[t("i",[s._v("configure()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ec39a9f6-c97d-4b7d-8843-d20358c1d194-0300e2.png",alt:"img"}})]),s._v(" "),t("p",[s._v("可以看到在"),t("strong",[t("i",[s._v("configure()")])]),s._v("中，就会去 bean 工厂中寻找**"),t("em",[s._v("UserDetailsService")]),t("strong",[s._v("类型的 bean，若是我们没有自定义")]),t("em",[s._v("UserDetailsService")]),t("strong",[s._v("的实现类的话，Spring Security 默认会生成一个")]),t("em",[s._v("InMemoryUserDetailsManager")]),s._v("**的实例：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/c6a7370c-4afb-4c5d-aa35-ba9c3406b1ed-27873e.png",alt:"img"}})]),s._v(" "),t("p",[s._v("**"),t("em",[s._v("InMemoryUserDetailsManager")]),t("strong",[s._v("是在")]),t("em",[s._v("UserDetailsServiceAutoConfiguration")]),s._v("**类中配置的：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/476f8954-abe3-4e26-bfe1-8c5b4abbf0e0-4e35eb.png",alt:"img"}})]),s._v(" "),t("p",[s._v("解决完**"),t("em",[s._v("UserDetailsService")]),t("strong",[s._v("的加载问题，现在我们来看看 Spring Security 是如何通过")]),t("em",[s._v("UserDetailsService")]),s._v("**获取用户信息的。")]),s._v(" "),t("p",[s._v("通过"),t("strong",[s._v("Spring Boot 中开启 Spring Security")]),s._v("一节的学习我们知道，登录判断的逻辑是在**"),t("em",[s._v("UsernamePasswordAuthenticationFilter")]),t("strong",[s._v("中进行的，因此我们在")]),t("em",[s._v("UsernamePasswordAuthenticationFilter")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("attemptAuthenticatio()")])]),s._v("中打上断点，然后启动项目，访问登录页，输入用户名和密码点击登录后，程序来到")]),t("em",[s._v("UsernamePasswordAuthenticationFilter")]),s._v("**中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/1282014b-fc29-4c2b-9316-9fdd638653c9-c57131.png",alt:"img"}})]),s._v(" "),t("p",[s._v("这里将验证的逻辑交由**"),t("em",[s._v("AuthenticationManager")]),s._v("**进行，我们进入"),t("strong",[t("i",[s._v("authenticate()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/5d511c93-3614-40e0-b3c9-9673c573d60f-780220.png",alt:"img"}})]),s._v(" "),t("p",[s._v("程序来到**"),t("em",[s._v("ProviderManager")]),s._v("**的"),t("strong",[t("i",[s._v("authenticate()")])]),s._v("中，这里将验证的逻辑委托给其父类进行，再次点击进入"),t("strong",[t("i",[s._v("authenticate()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/8dddd63e-c567-4b41-a9d9-8ef8aa6f2a92-449014.png",alt:"img"}})]),s._v(" "),t("p",[s._v("这里将验证的逻辑交由**"),t("em",[s._v("AuthenticationProvider")]),s._v("**进行，我们进入"),t("strong",[t("i",[s._v("authenticate()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/ec796a9b-7c65-49a2-9f9f-7685af7bd57b-570d6a.png",alt:"img"}})]),s._v(" "),t("p",[s._v("程序来到**"),t("em",[s._v("AbstractUserDetailsAuthenticationProvider")]),s._v("**的"),t("strong",[t("i",[s._v("authenticate()")])]),s._v("中，这里会根据用户名去寻找对应的用户实例，我们进入"),t("strong",[t("i",[s._v("retrieveUser()")])]),s._v("中：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://linkeq.oss-cn-chengdu.aliyuncs.com/img/2022/01/25/3980e264-c073-456a-b808-715edd85633a-fbf3c5.png",alt:"img"}})]),s._v(" "),t("p",[s._v("程序来到**"),t("em",[s._v("DaoAuthenticationProvider")]),t("strong",[s._v("的"),t("strong",[t("i",[s._v("retrieveUser()")])]),s._v("中，可以看到正是在这里，会从")]),t("em",[s._v("UserDetailsService")]),s._v("**的"),t("strong",[t("i",[s._v("loadUserByUsername()")])]),s._v("中寻找对应的用户信息。")]),s._v(" "),t("h2",{attrs:{id:"参考-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考-2"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),t("ol",[t("li",[t("a",{attrs:{href:"https://mrbird.cc/Spring-Security-Authentication.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Spring Security 自定义用户认证"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=e.exports}}]);